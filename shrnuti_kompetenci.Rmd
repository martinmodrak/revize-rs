---
title: "Shrnutí kompetencí"
toc-title: "Obsah"
abstract: "Tento dokument podává základní přehled o odpovědích na kompetenční otázky."
output:
  word_document:
    toc: yes
    reference_docx: public_data/output_template.docx
---


```{r setup, message=FALSE,warning=FALSE, results="hide", echo = FALSE}
source(here::here("R","setup_dotaznik.R"), encoding = "UTF-8")
knitr::opts_chunk$set(echo = FALSE)
```

```{r nacist_data, cache=TRUE}
source(here::here("R","datasety_dotaznik.R"), encoding = "UTF-8")

plots <- list() 
```

# Na co jsme se přesně ptali?

```{r}
otazky_rmd <- kompetence_otazky %>% arrange(ciselne_id) %>% mutate(rmd = paste0("- **", popis_pro_grafy,"** (",nazev_oblasti," - ", nazev_podoblasti,")\r\n  - ", text_otazky)) %>% pull(rmd) %>% paste0(collapse = "\r\n") 
```

Tučně je zkrácený popis, který budeme používat v tabulkách a grafech, za ním v závorce odkaz, jak je tato kompetence uvedena mezi "komptencemi skautské výchovy", pod tím přesné znění otázky, jak bylo v dotazníku.

`r otazky_rmd`

Ke každé kompetenci jsme měli 4 otázky (kategorie):

- Zvládám/ovládám to výborně.
- Je to pro mě velmi důležité.
- Rozvíjím se v tom.
- Skauting mi v rozvoji významně pomáhá.

Ke každé otázce vybírali odpověď na sedmibodové škále od "Zcela souhlasím" po "Zcela nesouhlasím".

Část respondentů měla kratší verzi dotazníku a vyjadřovala se tak jen k náhodně vybrané polovině otázek.

# Dle kategorie

Zde si shrneme celkové odpovědi ke každé kategorii.

## Zvládám

```{r}
plot_kategorie_kompetence <- function(data_long, kategorie, kategorie_popis) {
  data_to_plot <- data_long %>% 
    filter(kategorie_kompetence == kategorie, !is.na(kompetence_odpoved)) %>%
    group_by(kompetence_odpoved) %>%
    summarise(pocet = n()) %>% 
    ungroup() %>%
    mutate(podil = pocet / sum(pocet))

  data_to_plot %>% 
    ggplot(aes(x = kompetence_odpoved, y = podil, label = scales::percent(podil, accuracy = 1))) +
      geom_bar(stat = "identity") +
      geom_text(nudge_y = 0.03, size = 7) +
      scale_x_continuous(breaks = c(1,4,7), labels = c("Zcela nesouhlasím", "Neutrální", "Zcela souhlasím")) +
      theme(axis.title = element_blank(), axis.line.y = element_blank(), axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank()) + ggtitle(paste0('Celkové rozložení odpovědí\n"', kategorie_popis,'"')) + vodorovne_popisky_x
}

plots$zvladam_celkem <-  plot_kategorie_kompetence(hlavni_data_long, "zvladam", popis_pro_plot(hlavni_data, "duchovni_zivot.zvladam"))
plots$zvladam_celkem
```

Je spíš situace taková, že každý má nějakou slabou stránku, nebo spíš máme lidi, co všechno zvládají a lidi, co nic nezvládají? (zde nezvládám = sloučené všechny tři negativní odpovědi)

```{r}
data_nezvladam <- hlavni_data_long %>% filter(kategorie_kompetence == "zvladam") %>% 
  group_by(session) %>%
  summarise(pocet_nezvladam = sum(kompetence_odpoved <= 3), podil_nezvladam = mean(kompetence_odpoved <= 3), prumer_zvladam = mean(kompetence_odpoved)) %>%
  ungroup()

data_nezvladam %>%
  mutate(pocet_nezvladam = if_else(pocet_nezvladam < 5, as.character(pocet_nezvladam), "5 a více")) %>%
  group_by(pocet_nezvladam) %>%
  summarise(pocet_respondentu = n()) %>% table_format()
```

Jiný pohled na podobnou věc - když odpovědi převedeme na čísla 1-7 a zprůměrujeme za každého respondenta, jak to bude vypadat?

```{r}
data_nezvladam %>% ggplot(aes(x = prumer_zvladam)) + geom_histogram(binwidth = 0.5) + vodorovne_popisky_x + plot_annotation("Průměr hodnocení Zvládám","každého respondenta")
```


Které kompetence jsou nejčastěji nezvládané? Abychom se vyhnuli problémům s tím, že různí lidé mají různě kalibrovanou stupnici, podíváme se, jak často je daná kompetence pro respodenta nejhorší, tj. dostala nejnižší hodnocení ze všech (pokud je jich takových více, počítáme všechny). Žebříček se ale změní jen málo, když se podíváme na průměrné hodnocení napříč všemi respondenty nebo podíl těch, kteří vybrali jednu ze tří negativních odpovědí.

```{r}
tabulka_nezvladane <- hlavni_data_long %>% filter(kategorie_kompetence == "zvladam") %>% 
  group_by(popis_pro_grafy) %>% 
  summarise(pocet_nezvladam = sum(kompetence_nejnize), pocet_celkem = n(), podil = pocet_nezvladam/pocet_celkem) %>%
  ungroup() %>%
  arrange(desc(pocet_nezvladam)) %>%
  rename(kompetence = popis_pro_grafy)

tabulka_nezvladane %>% mutate(podil_nezvladam = scales::percent(podil)) %>% table_format()

plot_tabulka_extrem <- function(tabulka, indices = 5:1, text_y = 0.02) {
  tabulka[indices, ] %>% 
    mutate(kompetence = factor(kompetence, levels = kompetence)) %>% ggplot(aes(x = kompetence, y = podil, label = scales::percent(podil, accuracy = 1))) + geom_bar(stat = "identity") + coord_flip() + geom_text(y = text_y, size = 6, color = revize_cols("dark_blue")) + theme(axis.title = element_blank(), axis.ticks.x = element_blank(), axis.text.x =  element_blank())
}

plots$top_nezvladane <- plot_tabulka_extrem(tabulka_nezvladane) + plot_annotation("Nejčastěji nezvládané kompetence", subtitle = "Jak často je daná kompetence u respondenta 'nejhorší'")
plots$top_nezvladane
```

## Důležité

A nyní to samé pro "Je to pro mě velmi důležité" - zde je vidět, že respondenti považují v podstatě vše za důležité a spektrum odpovědí je tak na rozdíl od ostatních otázek posunuté hodně "doprava".

```{r}
plots$dulezite_celkem <- plot_kategorie_kompetence(hlavni_data_long, "dulezite", popis_pro_plot(hlavni_data, "duchovni_zivot.dulezite"))
plots$dulezite_celkem
```


```{r}
data_nedulezite <- hlavni_data_long %>% filter(kategorie_kompetence == "dulezite") %>% 
  group_by(session) %>%
  summarise(pocet_nedulezite = sum(kompetence_odpoved <= 3), podil_nedulezite = mean(kompetence_odpoved <= 3), prumer_dulezite = mean(kompetence_odpoved)) %>%
  ungroup()

data_nedulezite %>%
  mutate(pocet_nedulezite = if_else(pocet_nedulezite < 5, as.character(pocet_nedulezite), "5 a více")) %>%
  group_by(pocet_nedulezite) %>%
  summarise(pocet_respondentu = n()) %>% table_format()
```


```{r}
data_nedulezite %>% ggplot(aes(x = prumer_dulezite)) + geom_histogram(binwidth = 0.5) + vodorovne_popisky_x
```



Které kompetence jsou nejčastěji nedůležité?

```{r}
tabulka_nedulezite <- hlavni_data_long %>% filter(kategorie_kompetence == "dulezite") %>% 
  group_by(popis_pro_grafy) %>% 
  summarise(pocet_nedulezite = sum(kompetence_nejnize), podil = mean(kompetence_nejnize), podil_nedulezite = scales::percent(podil)) %>%
  arrange(desc(pocet_nedulezite)) %>%
  rename(kompetence = popis_pro_grafy)


tabulka_nedulezite

plots$top_nedulezite <- plot_tabulka_extrem(tabulka_nedulezite) + plot_annotation("Nejčastěji nedůležité kompetence", subtitle = "Jak často je daná kompetence u respondenta 'nejhorší'")
plots$top_nedulezite
```

```{r}
tabulka_dulezite <- hlavni_data_long %>% filter(kategorie_kompetence == "dulezite") %>% 
  group_by(popis_pro_grafy) %>% 
  summarise(pocet_dulezite = sum(kompetence_nejvyse), podil = mean(kompetence_nejvyse), podil_dulezite = scales::percent(podil)) %>%
  arrange(desc(pocet_dulezite)) %>%
  rename(kompetence = popis_pro_grafy)

plots$top_dulezite <- plot_tabulka_extrem(tabulka_dulezite, text_y = 0.05) + plot_annotation("Nejčastěji důležité kompetence", subtitle = "Jak často je u respondenta 'nejlepší'")
plots$top_dulezite

```



## Rozvíjím se v tom


```{r}
plots$rozvijim_celkem <- plot_kategorie_kompetence(hlavni_data_long, "rozvijim", popis_pro_plot(hlavni_data, "duchovni_zivot.rozvijim"))
plots$rozvijim_celkem

```

```{r}
data_nerozvijim <- hlavni_data_long %>% filter(kategorie_kompetence == "rozvijim") %>% 
  group_by(session) %>%
  summarise(pocet_nerozvijim = sum(kompetence_odpoved <= 3), podil_nerozvijim = mean(kompetence_odpoved <= 3), prumer_rozvijim = mean(kompetence_odpoved)) %>%
  ungroup()

data_nerozvijim %>%
  mutate(pocet_nerozvijim = if_else(pocet_nerozvijim < 5, as.character(pocet_nerozvijim), "5 a více")) %>%
  group_by(pocet_nerozvijim) %>%
  summarise(pocet_respondentu = n()) %>% table_format()
```


```{r}
data_nerozvijim %>% ggplot(aes(x = prumer_rozvijim)) + geom_histogram(binwidth = 0.5) + vodorovne_popisky_x
```

Které kompetence se nejčastěji nerozvíjí?

```{r}
tabulka_nerozvijim <- hlavni_data_long %>% filter(kategorie_kompetence == "rozvijim") %>% 
  group_by(popis_pro_grafy) %>% 
  summarise(pocet_nerozvijim = sum(kompetence_nejnize), podil = mean(kompetence_nejnize), podil_nerozvijim = scales::percent(podil)) %>%
  arrange(desc(pocet_nerozvijim)) %>%
  rename(kompetence = popis_pro_grafy)

tabulka_nerozvijim

plots$top_nerozvijim <- plot_tabulka_extrem(tabulka_nerozvijim) + plot_annotation("Nejčastěji nerozvíjené kompetence", subtitle = "Jak často je daná kompetence u respondenta 'nejhorší'")
plots$top_nerozvijim

```


## Skauting mi pomáhá

```{r}
plots$skauting_celkem <- plot_kategorie_kompetence(hlavni_data_long, "skauting", popis_pro_plot(hlavni_data, "duchovni_zivot.skauting")) + theme(plot.title = element_text(size = 30))
plots$skauting_celkem

```


```{r}
data_neskauting <- hlavni_data_long %>% filter(kategorie_kompetence == "skauting") %>% 
  group_by(session) %>%
  summarise(pocet_neskauting = sum(kompetence_odpoved <= 3), podil_neskauting = mean(kompetence_odpoved <= 3), prumer_skauting = mean(kompetence_odpoved)) %>%
  ungroup()

data_neskauting %>%
  mutate(pocet_neskauting = if_else(pocet_neskauting < 5, as.character(pocet_neskauting), "5 a více")) %>%
  group_by(pocet_neskauting) %>%
  summarise(pocet_respondentu = n()) %>% table_format()
```


```{r}
data_neskauting %>% ggplot(aes(x = prumer_skauting)) + geom_histogram(binwidth = 0.5) + vodorovne_popisky_x
```

Které kompetence skauting nejčastěji míjí?

```{r}
tabulka_neskauting <- hlavni_data_long %>% filter(kategorie_kompetence == "skauting") %>% 
  group_by(popis_pro_grafy) %>% 
  summarise(pocet_neskauting = sum(kompetence_nejnize), podil = mean(kompetence_nejnize), podil_neskauting = scales::percent(podil)) %>%
  arrange(desc(pocet_neskauting)) %>%
  rename(kompetence = popis_pro_grafy)

tabulka_neskauting

plots$top_neskauting <- plot_tabulka_extrem(tabulka_neskauting, text_y = 0.05) + plot_annotation("Skautingem nejčastěji nerozvíjené", subtitle = "Jak často je daná kompetence u respondenta 'nejhorší'")
plots$top_neskauting
```

Tohle je zajímavé: rodina asi nepřekvapí, ale aktivní občasntví, duchovní život, svědomí nebo sebepoznání jsou věci, kde má skauting unikátní postavení.

# Vývoj s věkem

## Zvládám to

```{r}
plot_kompetence_by(hlavni_data_long, "zvladam", age, all_together = TRUE)
plot_kompetence_by(hlavni_data_long, "zvladam", age)
plots$zvladam_age_smooth <- plot_kompetence_by_smooth(hlavni_data_long, "zvladam", age)
plots$zvladam_age_smooth
```



## Je to pro mě důležité


```{r}
plot_kompetence_by(hlavni_data_long, "dulezite", age, all_together = TRUE)
```

```{r}
plot_kompetence_by(hlavni_data_long, "dulezite", age)
plots$dulezite_age_smooth <-  plot_kompetence_by_smooth(hlavni_data_long, "dulezite", age)
plots$dulezite_age_smooth
```



## Rozvijim se v tom

```{r}
plot_kompetence_by(hlavni_data_long, "rozvijim", age, all_together = TRUE)
plot_kompetence_by(hlavni_data_long, "rozvijim", age)
plots$rozvijim_age_smooth <- plot_kompetence_by_smooth(hlavni_data_long, "rozvijim", age)
plots$rozvijim_age_smooth
```


## Skauting me rozviji

```{r}
plot_kompetence_by(hlavni_data_long, "skauting", age, all_together = TRUE)
plot_kompetence_by(hlavni_data_long, "skauting", age)
plots$skauting_age_smooth <- plot_kompetence_by_smooth(hlavni_data_long, "skauting", age)
plots$skauting_age_smooth 
```

# Rozdíly a nedostatky

```{r}
spocitej_data_rozdil <- function(hlavni_data_long, prvni, druhy, meritko_nazev) {
  typ_meritka <- meritka_kompetence[[meritko_nazev]]$type
  
  nazev_prvni <- rlang::as_name(enquo(prvni))
  nazev_druhy <- rlang::as_name(enquo(druhy))
  if(typ_meritka == "bool") {
    diff_fun <- function(x, y) {
      x & !y
    }
    popis <- paste0(nazev_prvni," ", popis_meritka(meritko_nazev), " zatímco ", nazev_druhy, " nikoliv")
  } else if(typ_meritka == "interval" || typ_meritka == "ordinal") {
    diff_fun <- `-`
    popis <- paste0(popis_meritka(meritko_nazev),": ",nazev_prvni," - ", nazev_druhy)
  }
  
  data_diff <- hlavni_data_long %>% select(session, kategorie_kompetence, kompetence_odpoved, popis_pro_grafy, !!meritko_nazev)  %>%
      rename(kompetence = popis_pro_grafy) %>% 
      pivot_wider(id_cols = c("session", "kompetence"), names_from = kategorie_kompetence, values_from = !!meritko_nazev) %>%
      mutate(rozdil = diff_fun({{prvni}},{{druhy}})) %>%
      filter(!is.na(rozdil))
  
  list(data = data_diff,
    popis = popis,
    meritko_nazev = meritko_nazev)
}

tabulka_rozdilu <- function(data_rozdil) {
  if(meritka_kompetence[[data_rozdil$meritko_nazev]]$type == "bool") {
    formatter = scales::percent
  } else {
    formatter = identity
  }
  nazev_prumer <- paste0(data_rozdil$popis, " (Průměr)")
  data_rozdil$data %>%
    group_by(kompetence) %>%
    summarise(prumer = mean(rozdil)) %>%
    arrange(desc(prumer)) %>%
    mutate(!!nazev_prumer := formatter(prumer)) 
}



```

## Důležité vs. zvládám

```{r}
tabulka_dulezite_zvladam <- hlavni_data_long %>% spocitej_data_rozdil(dulezite, zvladam, "kompetence_pozitivni") %>% tabulka_rozdilu()
tabulka_dulezite_zvladam %>%
    select(-prumer)

```

```{r}

hlavni_data_long %>% spocitej_data_rozdil(dulezite, zvladam, "kompetence_odpoved") %>% tabulka_rozdilu() %>%
    select(-prumer)
```


## Důležité vs. rozvíjím

Zajímavé je, že mezi top "nerozvíjené" patří aktivni obcan, tvořivost, které se zde posunuly dolů zatímco rodina k top nerozvíjeným nepatří, ale zde vede.

```{r}
tabulka_dulezite_rozvijim <- hlavni_data_long %>% spocitej_data_rozdil(dulezite, rozvijim, "kompetence_pozitivni") %>% tabulka_rozdilu()
tabulka_dulezite_rozvijim %>%
    select(-prumer)
```

```{r}
plot_tabulka_rozdil <- function(tabulka, indices = 5:1, text_y = 0.01) {
  tabulka[indices, ] %>% 
    mutate(kompetence = factor(kompetence, levels = kompetence)) %>% ggplot(aes(x = kompetence, y = prumer, label = scales::percent(prumer, accuracy = 1))) + geom_bar(stat = "identity") + coord_flip() + geom_text(y = text_y, size = 6, color = revize_cols("dark_blue")) + theme(axis.title = element_blank(), axis.ticks.x = element_blank(), axis.text.x =  element_blank())
}

plots$dulezite_rozvijim <- tabulka_dulezite_rozvijim %>% plot_tabulka_rozdil(indices = 7:1) + plot_annotation("Kontrast důležité x rozvíjím", subtitle = "Je to důležité, ale nerozvíjím se v tom")
plots$dulezite_rozvijim
```


Když zohledníme i velikost rozdílu, trochu se to přehází - hlavně vyplavou vztahy, svědomí a připraven na krize - opět něco, co se samo o sobě neobjevuje čast jako nerozvíjené.

```{r}
hlavni_data_long %>% spocitej_data_rozdil(dulezite, rozvijim, "kompetence_odpoved") %>% tabulka_rozdilu() %>%
    select(-prumer)
```



## Důležité vs. skauting me rozviji

Tohle velmi blízce kopíruje obecně to, kde skauting lidi nerozvíjí, takže nepřínáší moc další informace.

```{r}
tabulka_dulezite_skauting <-  hlavni_data_long %>% spocitej_data_rozdil(dulezite, skauting, "kompetence_pozitivni") %>% tabulka_rozdilu()
tabulka_dulezite_skauting %>%
    select(-prumer)
```

```{r}
# tabulka_dulezite_skauting %>% plot_tabulka_rozdil(text_y = 0.03) + plot_annotation("Kontrast důležité x skauting", subtitle = "Je to důležité, ale skauting mě v tom nerozvíjí")
```


## Rozvijim se vs. skauting me rozviji

Opět poměrně kopíruje jen ty věci, kde mě skauting nerozvíjí...

```{r}
hlavni_data_long %>% spocitej_data_rozdil(rozvijim, skauting, "kompetence_pozitivni") %>% tabulka_rozdilu() %>%
    select(-prumer)

```

# Ještě projít

TODO: Dát kategorie kompetencí přes sebe?
Kompetence - nemají starší lidi širší škálu?


## Ulozit obrazky

```{r}
save_list_of_plots(plots,"shrnuti_kompetenci")
```


# Doplnky a kontroly

Nevymyká se nějaká kompetence svým rozložením odpovědí?
```{r}
histogram_kompetence <- function(data_long, kategorie) {
  sloupec_pro_popis <- paste0("duchovni_zivot.", kategorie)
  popisek <- popis_pro_plot(hlavni_data, !!sloupec_pro_popis)
  data_long %>% filter(kategorie_kompetence == kategorie, !is.na(kompetence_odpoved)) %>%
    ggplot(aes(kompetence_odpoved)) +
      geom_histogram(binwidth = 1) + facet_wrap(~kompetence) +
      ggtitle("Rozložení odpovědí dle kompetencí", subtitle = popisek) +
      vodorovne_popisky_x
}

histogram_kompetence(hlavni_data_long, "zvladam")
histogram_kompetence(hlavni_data_long, "dulezite")
histogram_kompetence(hlavni_data_long, "rozvijim")
histogram_kompetence(hlavni_data_long, "skauting")
```

# Jak se liší různá měřítka?

Korelace:

```{r}
hlavni_data_long %>% select(one_of(names(meritka_kompetence))) %>%
  as.matrix() %>% cor()
```

```{r save_plots}
save_list_of_plots(plots,"shrnuti_kompetenci")
```
