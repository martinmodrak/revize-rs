---
title: "Výtahy ze sond - Orel"
output: html_notebook
---

```{r setup}
library(tidyverse)
library(brms)
library(scico)
options(mc.cores=parallel::detectCores())
```

```{r}
sondy <- readRDS("private_data/sondy_180420.rds")

sondy <- sondy %>%
  filter(q0_clen_junaka == "Ano") %>%
  mutate(
    max_funkce = if_else(
      q0_vedouci_strediska == "Ano", "vudce_strediska", if_else(
        q0_vudce_oddilu == "Ano", "vudce_oddilu",if_else(
          q0_vudce_rs_kmene == "Ano", "vudce_kmene", if_else(
            funkce_v_oddile_zastupce_VO == "Ano", "zastupce_v_oddilu", if_else(
              funkce_v_oddile_oddilovy_radce == "Ano", "oddilovy_radce", if_else(
                funkce_v_oddile_druzinovy_radce == "Ano", "druzinovy_radce", if_else(

                  q0_ve_vedeni_oddilu == "Ano" | funkce_v_oddile_clen_vedeni_oddilu == "Ano", "sirsi_vedeni_oddilu", "nic"
    ))))))),
    max_funkce = fct_relevel(max_funkce, "vudce_strediska", "vudce_oddilu", "vudce_kmene", "zastupce_v_oddilu", "oddilovy_radce","druzinovy_radce","sirsi_vedeni_oddilu"),
    celkova_spokojenost_s_programem_rs_kmenu = fct_relevel(celkova_spokojenost_s_programem_rs_kmenu, "Velmi nespokojen/a", "Spíše nespokojen/a","Spíše spokojen/a","Velmi spokojen/a"),
    organizace_spolecenstvi = fct_recode(vyrok_o_spolecenstvi, uzka_skupina = "Program připravuje úzká skupina lidí", vsichni =  "Na přípravě programu se podílí různí členové podle toho, o jakou činnost se jedná.", vudce =  "Program připravuje vůdce/vůdkyně kmene nebo roverského společenství"   )
  )
```

V datech ze sond je víc žen. Zároveň ženy proporčně častěji mají funkce (s vyjímkou vůdce střediska, vůdce kmene a oddílový rádce).

```{r}
pocet_pohlavi <- sondy %>% group_by(pohlavi) %>% summarise(pocet_pohlavi = length(id))

pocet_pohlavi

funkce_pohlavi <- sondy %>% filter(pohlavi != "N/A") %>% 
  group_by(pohlavi, max_funkce) %>% 
  summarise(pocet_funkce = length(id)) %>% 
  inner_join(pocet_pohlavi, by = c("pohlavi" = "pohlavi" )) %>%
  mutate(podil_funkce = pocet_funkce / pocet_pohlavi)

funkce_pohlavi %>%
  ggplot(aes(x = pohlavi, y = podil_funkce, color = max_funkce, group = max_funkce, shape = max_funkce)) + geom_point() + geom_line()

funkce_pohlavi %>%
  ggplot(aes(x = pohlavi, y = max_funkce, fill = podil_funkce)) + geom_bin2d(stat="identity")

```

Nedá se moc říct, že by spokojenost s programem RS kmene souvisela s funkcí ani s další sadou prediktorů.

```{r}
spokojenost <- sondy %>% 
  filter(!is.na(celkova_spokojenost_s_programem_rs_kmenu)) %>% 
  mutate(studium_ve_meste_strediska = fct_recode(studium_ve_meste_strediska, Ne = "Ne, většinu roku trávím mimo místo, kde mám svoje středisko"))

plot_spokojenost <- function(spokojenost, group, plot = "hist") {
  spokojenost$group <- spokojenost[[group]]
  spokojenost <- spokojenost %>% filter(!is.na(group))
  pocet_skupiny <- spokojenost %>% group_by(group) %>% summarise(pocet_skupiny = length(id))
  
  spokojenost_dle_group <- spokojenost %>% group_by(celkova_spokojenost_s_programem_rs_kmenu, group) %>% summarise(pocet_spokojenych = length(id))
  
  spokojenost_dle_group <- spokojenost_dle_group %>% 
    inner_join(pocet_skupiny, by = c("group" = "group")) %>%
    mutate(podil_spokojenych = pocet_spokojenych / pocet_skupiny) 
  
  if(plot == "heatmap") {
    spokojenost_dle_group %>% ggplot(aes(x = group, y = celkova_spokojenost_s_programem_rs_kmenu, fill = podil_spokojenych)) + geom_bin2d(stat = "identity") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_scico(palette = "roma") + xlab(group)
    
  } else if (plot == "hist") {
    mean_spokojenost <- spokojenost %>% group_by(group) %>% 
      summarise(mean_spokojenost = mean(as.integer(celkova_spokojenost_s_programem_rs_kmenu)))
    
    spokojenost_dle_group %>% ggplot(aes(x = celkova_spokojenost_s_programem_rs_kmenu, y = podil_spokojenych)) + geom_bar( stat = "identity") + 
      geom_label(data = pocet_skupiny, aes(label = pocet_skupiny), x = 1, y = 0.5, inherit.aes = FALSE) +
      geom_vline(data = mean_spokojenost, aes(xintercept = mean_spokojenost), color = "blue", size = 2) +
      facet_wrap(~group) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + xlab(group)
  } else {
    stop("Unrecognized plot")
  }
}

plot_spokojenost(spokojenost, "pohlavi")

plot_spokojenost(spokojenost, "max_funkce", plot="heatmap")
plot_spokojenost(spokojenost, "max_funkce")
plot_spokojenost(spokojenost, "je_ve_meste_univezita")
plot_spokojenost(spokojenost, "studium_ve_meste_strediska")

plot_spokojenost(spokojenost, "je_vice_rs_kmenu_ve_stredisku")
#realne_vedeni_oddilu

plot_spokojenost(spokojenost, "je_rs_kmen_registrovany")

plot_spokojenost(spokojenost, "povazujes_se_za_rovera")
plot_spokojenost(spokojenost, "organizace_spolecenstvi")

```

Zdá se, že kmeny, které jsou vedeny jsou trochu spokojenější.

```{r}
plot_spokojenost(spokojenost %>% 
                   mutate(rs_kmen_prvky = if_else(rs_kmen_prvky_vudce == "Ano",
                                                  if_else(rs_kmen_prvky_rada == "Ano", "vudce_rada", "vudce"),
                                                  if_else(rs_kmen_prvky_rada == "Ano", "rada","nic")))
                 , "rs_kmen_prvky")

```


S rostoucím počet let v kmeni se spokojenost s programem kmenu snižuje. Kmeny, které mají více členů jsou spíše spokojenější. Naopak souvislost s počtem let, kolik funguje není moc viditelná.

```{r}
plot_spokojenost_continuous <- function(spokojenost, var) {
  spokojenost$var <- spokojenost[[var]]
  
  spokojenost <- spokojenost %>% filter(!is.na(var))
  
  spokojenost %>% ggplot(aes(x = celkova_spokojenost_s_programem_rs_kmenu, y = var)) + geom_boxplot(outlier.alpha = 0) +
    geom_jitter( alpha = 0.2) + ylab(var)
}

plot_spokojenost_continuous(spokojenost %>% filter(kolik_let_jsi_rover < 20), "kolik_let_jsi_rover") #Odfiltruju jeden outlier

plot_spokojenost_continuous(spokojenost, "kmen_kolik_aktivnich_lidi")
plot_spokojenost_continuous(spokojenost, "kolik_let_rs_kmen_funguje")

```

Lineární model pro spokojenost. Ignorujeme ty, co mají neuvedené číselné hodnoty. U výběru z možností zavádíme kategorii "Neuvedeno" (hulvátský, ale co už). 
V zásadě se dá říct, že model podporuje to, co jsme  viděli v grafech výše: kmeny s více lidmi jsou spokojenější (to je nejsilnější pozorovaná korelace), kmeny s vůdcem jsou více spokojené. Ostatní věci se pohybují někde kolem nuly.

TODO: rozmyslet 1||x vs x (první se lépe čte, ale pro binární není moc vhodné)

```{r, message=FALSE}
std_normalize <- function(x) {
  (x - mean(x)) / sd(x)
}

replace_na <- function(x) {
  if_else(is.na(x), "Neuvedeno", as.character(x)) %>% factor()
}

spokojenost_pro_model <- spokojenost %>% 
  filter(!is.na(kmen_kolik_aktivnich_lidi), !is.na(kolik_let_rs_kmen_funguje)) %>%
  mutate(
    celkova_spokojenost_int = as.integer(celkova_spokojenost_s_programem_rs_kmenu),
    pohlavi = if_else(pohlavi == "N/A", "Neuvedeno", pohlavi),
    je_ve_meste_univezita = if_else(je_ve_meste_univezita == "N/A", "Neuvedeno", je_ve_meste_univezita),
    studium_ve_meste_strediska = replace_na(studium_ve_meste_strediska), 
    je_vice_rs_kmenu_ve_stredisku = replace_na(je_vice_rs_kmenu_ve_stredisku),
    je_rs_kmen_registrovany = replace_na(je_rs_kmen_registrovany),
    povazujes_se_za_rovera = replace_na(povazujes_se_za_rovera),
    kmen_kolik_aktivnich_lidi = std_normalize(kmen_kolik_aktivnich_lidi),
    kolik_let_rs_kmen_funguje = std_normalize(kolik_let_rs_kmen_funguje),
    organizace_spolecenstvi = replace_na(organizace_spolecenstvi),
    povazujes_se_za_rovera = replace_na(fct_recode(povazujes_se_za_rovera, Ano = "Ano, považuji se za rovera/rangers", Ne_ale_budu = "Ne, nyní se nepovažuji za rovera/rangers, ale myslím, že rover/rangers budu", Ne_ale_byl =  "Ne, nyní se nepovažuji za rovera/rangers, ale dříve jsem byl/a"))
    )

cat("Pro model dostupných ", nrow(spokojenost_pro_model), "řádků (",nrow(spokojenost_pro_model)/nrow(spokojenost), ")\n")


formula_spokojenost <- brmsformula(celkova_spokojenost_int ~ kmen_kolik_aktivnich_lidi + kolik_let_rs_kmen_funguje + (1|| pohlavi + rs_kmen_prvky_vudce + rs_kmen_prvky_rada + max_funkce + je_ve_meste_univezita + studium_ve_meste_strediska + je_vice_rs_kmenu_ve_stredisku + je_rs_kmen_registrovany + povazujes_se_za_rovera + organizace_spolecenstvi),
                                   family = cumulative("logit"))

#get_prior(formula_spokojenost, data = spokojenost_pro_model)
priors <- c(prior(normal(0,1), class = "b"),#prior(horseshoe(par_ratio = 0.3), class = "b"),
            prior(normal(0,1), class = "sd"))
#priors <- prior(normal(0,1), class = "b")

#make_stancode(formula_spokojenost, data = spokojenost_pro_model, prior = priors) 
fit_spokojenost <- brm(formula_spokojenost, data = spokojenost_pro_model, prior = priors, control = list(adapt_delta = 0.95))
fit_spokojenost

my_scale <- scale_y_discrete(labels = function(x) { gsub(",Intercept","", x)})

stanplot(fit_spokojenost, pars = "(^b_[^I])|(^r_[a-n])",type = "intervals") + #The regex for pars should filter out the intercept terms 
  my_scale 
stanplot(fit_spokojenost, pars = "(^r_[^a-n])",type = "intervals") + #The regex for pars should filter out the intercept terms 
  my_scale 

```

