---
title: "Výtahy ze sond - Orel"
output: html_notebook
---

```{r setup}
library(tidyverse)
library(brms)
library(scico)
library(mice)
library(here)
library(cowplot)
options(mc.cores=parallel::detectCores())
```

```{r}
sondy <- readRDS("private_data/sondy_180420.rds")

sondy <- sondy %>%
  filter(q0_clen_junaka == "Ano") %>%
  mutate(
    max_funkce = if_else(
      q0_vedouci_strediska == "Ano", "vudce_strediska", if_else(
        q0_vudce_oddilu == "Ano", "vudce_oddilu",if_else(
          q0_vudce_rs_kmene == "Ano", "vudce_kmene", if_else(
            funkce_v_oddile_zastupce_VO == "Ano", "zastupce_v_oddilu", if_else(
              funkce_v_oddile_oddilovy_radce == "Ano", "oddilovy_radce", if_else(
                funkce_v_oddile_druzinovy_radce == "Ano", "druzinovy_radce", if_else(

                  q0_ve_vedeni_oddilu == "Ano" | funkce_v_oddile_clen_vedeni_oddilu == "Ano", "sirsi_vedeni_oddilu", "nic"
    ))))))),
    max_funkce = fct_relevel(max_funkce, "vudce_strediska", "vudce_oddilu", "vudce_kmene", "zastupce_v_oddilu", "oddilovy_radce","druzinovy_radce","sirsi_vedeni_oddilu"),
    max_funkce_v_kmeni = case_when(
      rs_kmen_moje_funkce_vudce == "Ano" ~ "vudce",
      rs_kmen_moje_funkce_rada == "Ano" ~ "rada",
      !is.na(rs_kmen_moje_funkce_jine) ~ "jine",
      rs_kmen_moje_funkce_clen == "Ano" ~ "clen",
      TRUE ~ "zadna"
    ),
    max_funkce_v_kmeni = fct_relevel(max_funkce_v_kmeni, "vudce","rada","jine","clen", "zadna"),
    celkova_spokojenost_s_programem_rs_kmenu = fct_relevel(celkova_spokojenost_s_programem_rs_kmenu, "Velmi nespokojen/a", "Spíše nespokojen/a","Spíše spokojen/a","Velmi spokojen/a"),
    organizace_spolecenstvi = fct_recode(vyrok_o_spolecenstvi, uzka_skupina = "Program připravuje úzká skupina lidí", vsichni =  "Na přípravě programu se podílí různí členové podle toho, o jakou činnost se jedná.", vudce =  "Program připravuje vůdce/vůdkyně kmene nebo roverského společenství"   ),
    studium_ve_meste_strediska = fct_recode(studium_ve_meste_strediska, Ne = "Ne, většinu roku trávím mimo místo, kde mám svoje středisko")
  )
```

V datech ze sond je víc žen. Zároveň ženy proporčně častěji mají funkce (s vyjímkou vůdce střediska, vůdce kmene a oddílový rádce).

```{r}
pocet_pohlavi <- sondy %>% group_by(pohlavi) %>% summarise(pocet_pohlavi = length(id))

pocet_pohlavi

funkce_pohlavi <- sondy %>% filter(pohlavi != "N/A") %>% 
  group_by(pohlavi, max_funkce) %>% 
  summarise(pocet_funkce = length(id)) %>% 
  inner_join(pocet_pohlavi, by = c("pohlavi" = "pohlavi" )) %>%
  mutate(podil_funkce = pocet_funkce / pocet_pohlavi)

funkce_pohlavi %>%
  ggplot(aes(x = pohlavi, y = podil_funkce, color = max_funkce, group = max_funkce, shape = max_funkce)) + geom_point() + geom_line()

funkce_pohlavi %>%
  ggplot(aes(x = pohlavi, y = max_funkce, fill = podil_funkce)) + geom_bin2d(stat="identity")

```

Nedá se moc říct, že by spokojenost s programem RS kmene souvisela s funkcí ani s další sadou prediktorů.

```{r}
spokojenost <- sondy %>% 
  filter(!is.na(celkova_spokojenost_s_programem_rs_kmenu))

plot_spokojenost <- function(spokojenost, group, plot = "hist") {
  spokojenost$group <- spokojenost[[group]]
  spokojenost <- spokojenost %>% filter(!is.na(group))
  pocet_skupiny <- spokojenost %>% group_by(group) %>% summarise(pocet_skupiny = length(id))
  
  spokojenost_dle_group <- spokojenost %>% group_by(celkova_spokojenost_s_programem_rs_kmenu, group) %>% summarise(pocet_spokojenych = length(id))
  
  spokojenost_dle_group <- spokojenost_dle_group %>% 
    inner_join(pocet_skupiny, by = c("group" = "group")) %>%
    mutate(podil_spokojenych = pocet_spokojenych / pocet_skupiny) 
  
  if(plot == "heatmap") {
    spokojenost_dle_group %>% ggplot(aes(x = group, y = celkova_spokojenost_s_programem_rs_kmenu, fill = podil_spokojenych)) + geom_bin2d(stat = "identity") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_scico(palette = "roma") + xlab(group)
    
  } else if (plot == "hist") {
    mean_spokojenost <- spokojenost %>% group_by(group) %>% 
      summarise(mean_spokojenost = mean(as.integer(celkova_spokojenost_s_programem_rs_kmenu)))
    
    spokojenost_dle_group %>% ggplot(aes(x = celkova_spokojenost_s_programem_rs_kmenu, y = podil_spokojenych)) + geom_bar( stat = "identity") + 
      geom_label(data = pocet_skupiny, aes(label = pocet_skupiny), x = 1, y = 0.5, inherit.aes = FALSE) +
      geom_vline(data = mean_spokojenost, aes(xintercept = mean_spokojenost), color = "blue", size = 2) +
      facet_wrap(~group) + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + xlab(group)
  } else {
    stop("Unrecognized plot")
  }
}

plot_spokojenost(spokojenost, "pohlavi")

plot_spokojenost(spokojenost, "max_funkce", plot="heatmap")
plot_spokojenost(spokojenost, "max_funkce")
plot_spokojenost(spokojenost, "max_funkce_v_kmeni")
plot_spokojenost(spokojenost, "je_ve_meste_univezita")
plot_spokojenost(spokojenost, "studium_ve_meste_strediska")

plot_spokojenost(spokojenost, "je_vice_rs_kmenu_ve_stredisku")
#realne_vedeni_oddilu

plot_spokojenost(spokojenost, "je_rs_kmen_registrovany")

plot_spokojenost(spokojenost, "povazujes_se_za_rovera")
plot_spokojenost(spokojenost, "organizace_spolecenstvi")

```

Zdá se, že kmeny, které jsou vedeny jsou trochu spokojenější.

```{r}
plot_spokojenost(spokojenost %>% 
                   mutate(rs_kmen_prvky = if_else(rs_kmen_prvky_vudce == "Ano",
                                                  if_else(rs_kmen_prvky_rada == "Ano", "vudce_rada", "vudce"),
                                                  if_else(rs_kmen_prvky_rada == "Ano", "rada","nic")))
                 , "rs_kmen_prvky")

```


S rostoucím počet let v kmeni se spokojenost s programem kmenu snižuje. Kmeny, které mají více členů jsou spíše spokojenější. Naopak souvislost s počtem let, kolik funguje není moc viditelná.

```{r}
plot_spokojenost_continuous <- function(spokojenost, var) {
  spokojenost$var <- spokojenost[[var]]
  
  spokojenost <- spokojenost %>% filter(!is.na(var))
  
  spokojenost %>% ggplot(aes(x = celkova_spokojenost_s_programem_rs_kmenu, y = var)) + geom_boxplot(outlier.alpha = 0) +
    geom_jitter( alpha = 0.2) + ylab(var)
}

plot_spokojenost_continuous(spokojenost %>% filter(kolik_let_jsi_rover < 20), "kolik_let_jsi_rover") #Odfiltruju jeden outlier

plot_spokojenost_continuous(spokojenost, "kmen_kolik_aktivnich_lidi")
plot_spokojenost_continuous(spokojenost, "kolik_let_rs_kmen_funguje")

```

Lineární model pro spokojenost. Ignorujeme ty, co mají neuvedené číselné hodnoty. U výběru z možností zavádíme kategorii "Neuvedeno" (hulvátský, ale co už). 
V zásadě se dá říct, že model podporuje to, co jsme  viděli v grafech výše: kmeny s více lidmi jsou spokojenější (to je nejsilnější pozorovaná korelace), kmeny s vůdcem jsou více spokojené. Ostatní věci se pohybují někde kolem nuly.

TODO: rozmyslet 1||x vs x (první se lépe čte, ale pro binární není moc vhodné)

```{r, message=FALSE}
std_normalize <- function(x) {
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}

replace_na <- function(x) {
  if_else(is.na(x), "Neuvedeno", as.character(x)) %>% factor()
}

normalized_translator <- function(x) {
  function(val) {
    (val - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }
}

zakladni_data_pro_model <- sondy %>% 
  filter(!is.na(kolik_let_rs_kmen_funguje), !is.na(kmen_kolik_aktivnich_lidi)) %>%
  mutate(
    celkova_spokojenost_int = as.integer(celkova_spokojenost_s_programem_rs_kmenu),
    pohlavi = if_else(pohlavi == "N/A", "Neuvedeno", pohlavi),
    je_ve_meste_univezita = if_else(je_ve_meste_univezita == "N/A", "Neuvedeno", je_ve_meste_univezita),
    studium_ve_meste_strediska = replace_na(studium_ve_meste_strediska), 
    je_vice_rs_kmenu_ve_stredisku = replace_na(je_vice_rs_kmenu_ve_stredisku),
    je_rs_kmen_registrovany = replace_na(je_rs_kmen_registrovany),
    povazujes_se_za_rovera = replace_na(povazujes_se_za_rovera),
    kmen_kolik_aktivnich_lidi_orig = kmen_kolik_aktivnich_lidi,
    kolik_let_rs_kmen_funguje_orig = kolik_let_rs_kmen_funguje,
    kmen_kolik_aktivnich_lidi = std_normalize(kmen_kolik_aktivnich_lidi),
    kolik_let_rs_kmen_funguje = std_normalize(kolik_let_rs_kmen_funguje),
    organizace_spolecenstvi = replace_na(organizace_spolecenstvi),
    povazujes_se_za_rovera = replace_na(fct_recode(povazujes_se_za_rovera, Ano = "Ano, považuji se za rovera/rangers", Ne_ale_budu = "Ne, nyní se nepovažuji za rovera/rangers, ale myslím, že rover/rangers budu", Ne_ale_byl =  "Ne, nyní se nepovažuji za rovera/rangers, ale dříve jsem byl/a"))
    )

normalized_translator_aktivni_lide <- normalized_translator(zakladni_data_pro_model$kmen_kolik_aktivnich_lidi_orig)
normalized_translator_let_funguje <- normalized_translator(zakladni_data_pro_model$kolik_let_rs_kmen_funguje)

spokojenost_pro_model <- zakladni_data_pro_model %>%
  filter(!is.na(celkova_spokojenost_s_programem_rs_kmenu))

# predictor_matrix <- matrix(0, nrow = 3, ncol = ncol(spokojenost_pro_model))
# colnames(predictor_matrix) <- names(spokojenost_pro_model)
# predictor_matrix[, c("kmen_kolik_aktivnich_lidi","kolik_let_rs_kmen_funguje", "je_rs_kmen_registrovany", "je_ve_meste_univezita")] <- 1
# predictor_matrix[3,c("frekvence_rs_akci_celodenni_akce","frekvence_rs_akci_schuzky",
#                                             "frekvence_rs_akci_vicedenni_akce","frekvence_rs_akci_tabory_expedice")] <- 1


# spokojenost_imputed <- mice(spokojenost_pro_model, 
#                             blocks = list("kmen_kolik_aktivnich_lidi","kolik_let_rs_kmen_funguje", 
#                                           c("frekvence_rs_akci_celodenni_akce","frekvence_rs_akci_schuzky",
#                                             "frekvence_rs_akci_vicedenni_akce","frekvence_rs_akci_tabory_expedice")),
#                             predictorMatrix = predictor_matrix)
cat("Pro model dostupných ", nrow(spokojenost_pro_model), "řádků (",nrow(spokojenost_pro_model)/nrow(sondy), ")\n")


formula_spokojenost <- brmsformula(celkova_spokojenost_int ~ kmen_kolik_aktivnich_lidi + kolik_let_rs_kmen_funguje + (1|| pohlavi + rs_kmen_prvky_vudce + rs_kmen_prvky_rada + max_funkce + max_funkce_v_kmeni + je_ve_meste_univezita + studium_ve_meste_strediska + je_vice_rs_kmenu_ve_stredisku + je_rs_kmen_registrovany + povazujes_se_za_rovera + organizace_spolecenstvi),
                                   family = cumulative("logit"))

#get_prior(formula_spokojenost, data = spokojenost_pro_model)
priors <- c(prior(normal(0,1), class = "b"),#prior(horseshoe(par_ratio = 0.3), class = "b"),
            prior(normal(0,1), class = "sd"))
#priors <- prior(normal(0,1), class = "b")

#make_stancode(formula_spokojenost, data = spokojenost_pro_model, prior = priors) 
fit_spokojenost <- brm(formula_spokojenost, data = spokojenost_pro_model, prior = priors, control = list(adapt_delta = 0.95), file = here("local_data","fit_spokojenost"))
fit_spokojenost

my_scale <- scale_y_discrete(labels = function(x) { gsub(",Intercept","", x)})

stanplot(fit_spokojenost, pars = "(^b_[^I])|(^r_[a-n])",type = "intervals") + #The regex for pars should filter out the intercept terms 
  my_scale 
stanplot(fit_spokojenost, pars = "(^r_[^a-n])",type = "intervals") + #The regex for pars should filter out the intercept terms 
  my_scale 

```


```{r}
effects_by_prediction <- function(fit, orig_data, var_name, var_values, var_labels = var_values, response_title, num_low_categories, n_samples = 500, max_lines = 200) {

    data_for_prediction_all_values <- var_values %>% imap_dfr(function(var_value, var_value_index) {
    data_for_prediction <- orig_data
    data_for_prediction[, var_name] <- var_value
    data_for_prediction$var_value_index <- var_value_index
    data_for_prediction 
  })
  
  prediction_array <- posterior_linpred(fit, newdata = data_for_prediction_all_values, nsamples = n_samples, transform = TRUE)
  prediction <- apply(prediction_array, MARGIN = c(1,2), FUN = function(x) {1 - sum(x[1:num_low_categories])})
  
  predicted_data <- prediction %>% t() %>% as.tibble() %>% 
      mutate(id = data_for_prediction_all_values$id, 
             var_value = factor(data_for_prediction_all_values[[var_name]], levels = var_values, labels = var_labels), 
             var_value_index = data_for_prediction_all_values$var_value_index) %>%  
      gather("sample", "response", -id, -var_value, -var_value_index) %>%
      mutate(sample = factor(sample), id_sample = factor(paste(id, sample, sep = "__"))) 
  
  predicted_data_for_lines <- predicted_data %>%
      filter(id_sample %in% sample(unique(id_sample), max_lines))

  data_sign <- predicted_data_for_lines %>% filter(var_value_index < length(var_values)) %>%
    mutate(next_var_value_index = var_value_index + 1) %>%
    inner_join(predicted_data_for_lines %>% select(id_sample, response, var_value_index) %>% rename(next_response = response, next_var_value_index = var_value_index),
         by = c("id_sample" = "id_sample", "next_var_value_index" = "next_var_value_index")) %>%
    mutate(sign = if_else(response < next_response, "positive","negative") %>% 
             factor(levels = c("negative", "positive"))) %>%
    select(var_value_index, sign, id_sample)
  
  # data_diff %>%
  #   mutate(increased = next_value > value, equal = next_value == value, decreased = next_value < value,
  #          change = paste0(var_values[var_value_index], "->", var_values[next_var_value_index])) %>%
  #   group_by(change, sample) %>%
  #   summarise(increased = mean(increased), equal = mean(equal), decreased = mean(decreased)) %>%
  #   gather("type","chance", increased, equal, decreased) %>%
  #   ggplot(aes(x = type, y = chance, group = type)) + geom_boxplot() + facet_wrap(~change)
  # 
  
  predicted_data_for_lines_sign <- predicted_data_for_lines %>%
    left_join(data_sign, by = c("var_value_index","id_sample")) %>%
    mutate(sign = if_else(is.na(sign), factor("positive", levels = c("negative","positive")),sign))
  
  predicted_data %>%
    group_by(var_value) %>%
    summarise(Estimate = median(response), 
              lower = quantile(response, 0.025),
              upper = quantile(response, 0.975),
              lower50 = quantile(response, 0.25),
              upper50 = quantile(response, 0.75)
              ) %>%
    ggplot(aes(x = var_value)) +
      geom_line(data = predicted_data_for_lines_sign,
                mapping = aes(x = var_value, y = response, group = id_sample, color = sign),
                inherit.aes = FALSE,
                alpha = 0.2) +
      geom_linerange(aes(ymin = lower50, ymax = upper50), size = 2) +
      geom_linerange(aes(ymin = lower, ymax = upper)) +
      scale_color_discrete(drop = FALSE) +
      scale_y_continuous(response_title, limits = c(0,1)) +
      scale_x_discrete(var_name) +
      guides(color = guide_legend(override.aes = list(alpha=1))) +
      if(length(var_values) > 4 && max(nchar(var_labels) > 4)) {
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) 
      } else {
        NULL
      }
  
}
```

```{r}
effects_by_prediction_spokojenost <- function(var_name, var_values = levels(spokojenost_pro_model[[var_name]]), var_labels = var_values) {
  effects_by_prediction(fit_spokojenost, spokojenost_pro_model, var_name, var_values, var_labels = var_labels,
                        num_low_categories = 2, response_title = "P(spíše spokojen než ne)")
}

pocty_lidi <- seq(5,30, by = 5)
effects_by_prediction_spokojenost("kmen_kolik_aktivnich_lidi", normalized_translator_aktivni_lide(pocty_lidi), var_labels = pocty_lidi)

roky_kmene <- c(1,2,3,4,5)
effects_by_prediction_spokojenost("kolik_let_rs_kmen_funguje", normalized_translator_let_funguje(roky_kmene), var_labels = roky_kmene )


effects_by_prediction_spokojenost("rs_kmen_prvky_vudce", c("Ne", "Ano"))

effects_by_prediction_spokojenost("rs_kmen_prvky_vudce", c("Ne", "Ano"))
effects_by_prediction_spokojenost("rs_kmen_prvky_rada", c("Ne", "Ano"))
effects_by_prediction_spokojenost("organizace_spolecenstvi", c("Nevím", "Neuvedeno","vudce","uzka_skupina", "vsichni"))

effects_by_prediction_spokojenost("povazujes_se_za_rovera", c("Neuvedeno","Ne_ale_budu","Ne_ale_byl", "Ano"))

effects_by_prediction_spokojenost("studium_ve_meste_strediska", c("Ne", "Ano"))

effects_by_prediction_spokojenost("max_funkce")

effects_by_prediction_spokojenost("je_vice_rs_kmenu_ve_stredisku")
effects_by_prediction_spokojenost("je_rs_kmen_registrovany")



```




Aktivita - vyhodime, kdo nevyplnil vse, pokud vyplnil aspon jedno, dame vsude jinde "Nikdy"

```{r}
recode_frekvence <- function(x) {
  #Davame default "Nikdy"
  recode(x, .default = 1, `Nikdy` = 1, `Méně často než 1 za rok` = 2, `Asi jednou za půl roku` = 3, `Asi jednou za čtvrt roku` = 4, `Asi jednou měsíčně` = 5, `Asi jednou za 14 dní` = 6, `Každý týden nebo častěji` = 7) %>% as.integer() 
}


aktivita_pro_model <- zakladni_data_pro_model %>%
  filter(!is.na(frekvence_rs_akci_schuzky) || !is.na(frekvence_rs_akci_celodenni_akce) || !is.na(frekvence_rs_akci_vicedenni_akce) || !is.na(frekvence_rs_akci_tabory_expedice)) %>%
  mutate(    
    frekvence_rs_akci_celodenni_akce = recode_frekvence(frekvence_rs_akci_celodenni_akce),
    frekvence_rs_akci_schuzky = recode_frekvence(frekvence_rs_akci_schuzky),
    frekvence_rs_akci_vicedenni_akce = recode_frekvence(frekvence_rs_akci_vicedenni_akce),
    frekvence_rs_akci_tabory_expedice = recode_frekvence(frekvence_rs_akci_tabory_expedice)
 )

cat("Pro model dostupných ", nrow(aktivita_pro_model), "řádků (",nrow(aktivita_pro_model)/nrow(sondy), ")\n")


formula_aktivita <- update.formula(formula_spokojenost, cbind(frekvence_rs_akci_celodenni_akce, frekvence_rs_akci_schuzky, frekvence_rs_akci_vicedenni_akce, frekvence_rs_akci_tabory_expedice) ~ .)
#formula_aktivita <- update.formula(formula_spokojenost, frekvence_rs_akci_celodenni_akce ~ .)

response_names <- 
  c("frekvence_rs_akci_celodenni_akce","frekvence_rs_akci_schuzky","frekvence_rs_akci_vicedenni_akce", "frekvence_rs_akci_tabory_expedice") %>%
  #"" %>%
  gsub("_","", ., fixed = TRUE)

priors_multivar <- 
  response_names %>%
  map(function(resp) { c(set_prior("normal(0,1)", class = "b", resp = resp),#prior(horseshoe(par_ratio = 0.3), class = "b"),
            set_prior("normal(0,1)", class = "sd", resp = resp)) }) %>% do.call(c, .)


fit_aktivita <- brm(formula_aktivita, data = aktivita_pro_model, prior = priors_multivar, control = list(adapt_delta = 0.95), family = cumulative("logit"), file = here("local_data","fit_aktivita")) 
fit_aktivita

my_scale_aktivita <- scale_y_discrete(labels = function(x) { gsub(",Intercept","", x) %>% gsub("frekvence[^_\\[]*","", .)})

response_names %>% walk(
  function(resp) {
    p1 <- stanplot(fit_aktivita, pars = paste0("(^b_",resp,"_[^I])|(^r_[a-n].*",resp,")"),type = "intervals") + #The regex for pars should filter out the intercept terms 
      my_scale_aktivita + ggtitle(resp)
    p2 <- stanplot(fit_aktivita, pars = paste0("(^r_[^a-n].*",resp,")"),type = "intervals") + #The regex for pars should filter out the intercept terms 
      my_scale_aktivita + ggtitle(resp)
    print(p1)
    print(p2)
  }
)

```

