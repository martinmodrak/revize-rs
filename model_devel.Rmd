---
title: "Developing Stan model"
output: html_notebook
---


```{r}
library(rstan)
library(tidybayes)
library(tidyverse)
library(here)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
source(here("R","simulator.R"))
source(here("R","evaluation_tools.R"))
source(here("R","sampling_multi.R"))
source(here("R","sbc.R"))

```

```{r}
model <- stan_model(here("stan","main_model.stan"))
```


```{r}
ncat = 4
repeat {
  test_data <- simulate_data(N = 100, N_fixed = 2, N_random_groups = c(2,4), ncat = ncat, N_monotonic = 1)
  if(length(unique(test_data$observed$Y)) == ncat) {
    break;
  }
  cat("Reject\n")
}
fit <- sampling(model, data = test_data$observed)
evaluation_summary(fit, test_data$true)
```

```{r}
set.seed(15673459)
sbc_steps <- 500
sbc_results <- sbc(model, function() { simulate_data(N = 100, N_fixed = 2, ncat = 4, N_random_groups = c(2,4),  N_monotonic = 1)}, N_steps = sbc_steps)
saveRDS(sbc_results, "sbc_500.rds")
plot_sbc_params(sbc_results$params %>% filter(!grepl("zeta", param_name)))
plot_sbc_params(sbc_results$params %>% filter(grepl("zeta", param_name)))

```

