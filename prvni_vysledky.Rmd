---
title: "První výsledky"
output: html_notebook
---

```{r setup}
if(!grepl("cz|utf", Sys.getlocale(), ignore.case = TRUE)) {
  Sys.setlocale(locale= 'English_United States.1250')
}
library(lubridate)
library(tidyverse)
library(formr)
library(here)
library(RCzechia)
library(sf)
library(cowplot)
library(showtext)

save_format <- ".svg"

theme_set(theme_cowplot())
dark_blue_color <- "#0040ae"
darkest_fill <- "#668cce"
midd_fill <- "#b2c5e6"
# theme_update(text = element_text(family = "Roboto", color = "white"), 
#              plot.background = element_rect(fill = dark_blue_color), 
#              line = element_line(color = "white"), 
#              rect = element_rect(color = "white"), 
#              axis.text = element_text(color = "white", face = "bold"), 
#              axis.title = element_text(color = "white"),
#              axis.line = element_line(color = "white"), axis.ticks = element_line(color = "white"),
#              strip.background = element_rect(color = "white", fill = darkest_fill))


# sysfonts::font_add_google("Roboto")
# sysfonts::font_add(family = "Skaut Bold", paste0(Sys.getenv("APPDATA"),"/../Local/Microsoft/Windows/Fonts/skaut-bold-webfont.otf"))
# showtext_auto()

source(here::here("R","tools_dotaznik.R"), encoding = "UTF-8")

```

```{r}
cela_data_raw <- nacti_dotaznik()
cela_data <- cela_data_raw %>% vyfiltruj_pouzitelne() %>% preprocess_dat(verbose = FALSE)  
check_vysledky(cela_data)
```


```{r}
dokonceno <- sum(!is.na(cela_data$ended.hlavni), na.rm = TRUE)
rozpracovano <- sum(!is.na(cela_data$kategorie_respondenta) & is.na(cela_data$ended.hlavni))
```

Dotazník dokončilo neuvěřitelných `r dokonceno` roverů a dalších `r rozpracovano` ho vyplnilo alespoň zčásti.


```{r}
summarise_multiple_choice(cela_data, problemy_roveringu) %>% arrange(desc(podil_ano))
```

```{r}
summarise_multiple_choice(cela_data, problemy_roveringu_stredisko) %>% arrange(desc(podil_ano))
```

```{r}
summarise_multiple_choice(cela_data, co_zazil) %>% arrange(desc(podil_ano))
```

```{r}
summarise_multiple_choice(cela_data, s_cim_spokojen) %>% arrange(desc(podil_ano))
summarise_multiple_choice(cela_data, s_cim_nespokojen) %>% arrange(desc(podil_ano))

```

```{r}
summarise_multiple_choice(cela_data, sluzba) %>% arrange(desc(podil_ano))

```


```{r}
summarise_multiple_choice(cela_data, organizace_spolecenstvi) %>% arrange(desc(podil_ano))

```

```{r}
summarise_multiple_choice(cela_data, vyroky_o_roveringu_zazil) %>% arrange(desc(podil_ano))
summarise_multiple_choice(cela_data, vyroky_o_roveringu_zazil_2) %>% arrange(desc(podil_ano))

```


```{r}
expanded <- cela_data %>% expand_kompetence()
```

## Je to pro mě důležité

```{r}
tabulka_kompetence <- function(expanded, kategorie) {
  expanded %>% filter(kategorie_kompetence == kategorie) %>%
    group_by(kompetence) %>%
    summarise(prumer = mean(kompetence_odpoved, na.rm = TRUE), pocet = sum(!is.na(kompetence_odpoved))) %>%
    arrange(desc(prumer))
}

tabulka_kompetence(expanded, "dulezite")
```

```{r}
histogram_kompetence <- function(expanded, kategorie) {
  expanded %>% filter(kategorie_kompetence == kategorie, !is.na(kompetence_odpoved)) %>%
    ggplot(aes(kompetence_odpoved)) +
      geom_histogram(binwidth = 1) + facet_wrap(~kompetence) +
      theme(strip.text = element_text(size = 8))
}

histogram_kompetence(expanded, "dulezite")
```

```{r}
plot_kompetence_by_age <- function(expanded, kategorie) {
  expanded %>% filter(kategorie_kompetence == kategorie, !is.na(kompetence_odpoved), age >= 15, age <= 26) %>%
    group_by(age, kompetence) %>%
    summarise(prumer = mean(kompetence_odpoved) ,
              sem = sd(kompetence_odpoved) / sqrt(n())
              ) %>%
    group_by(kompetence) %>%
    mutate(od_prumeru = prumer - mean(prumer), low = od_prumeru - 1.96 * sem, high = od_prumeru + 1.96 * sem) %>%
    ungroup() %>%
    ggplot(aes(x = age, y = od_prumeru, ymin = low, ymax = high)) +
      geom_ribbon(fill = midd_fill) +
      geom_line() + facet_wrap(~kompetence) +
      theme(strip.text = element_text(size = 8))
}

plot_kompetence_by_age_smooth <- function(expanded, kategorie) {
  expanded %>% filter(kategorie_kompetence == kategorie, !is.na(kompetence_odpoved), age >= 15, age <= 26) %>%
    group_by(kompetence) %>%
    mutate(od_prumeru = kompetence_odpoved - mean(kompetence_odpoved)) %>%
    ggplot(aes(x = age, y = od_prumeru)) +
      geom_smooth() + facet_wrap(~kompetence) +
      theme(strip.text = element_text(size = 8)) 
}


plot_kompetence_by_age(expanded, "dulezite")
plot_kompetence_by_age_smooth(expanded, "dulezite")
```

## Zvládám to

```{r}
tabulka_kompetence(expanded, "zvladam")
```

```{r}
histogram_kompetence(expanded, "zvladam")
```


```{r}
plot_kompetence_by_age(expanded, "zvladam")
plot_kompetence_by_age_smooth(expanded, "zvladam")
```

## Rozvijim se v tom

```{r}
tabulka_kompetence(expanded, "rozvijim")
```

```{r}
histogram_kompetence(expanded, "rozvijim")
```

```{r}
plot_kompetence_by_age(expanded, "rozvijim")
plot_kompetence_by_age_smooth(expanded, "rozvijim")
```

## Skauting me rozviji

```{r}
tabulka_kompetence(expanded, "skauting")
```

```{r}
histogram_kompetence(expanded, "skauting")
```

```{r}
plot_kompetence_by_age(expanded, "skauting")
plot_kompetence_by_age_smooth(expanded, "skauting")
```

## Rozvijim se vs. skauting me rozviji

Všude číslo větší než 0 znamená, že "rozvíjím se" mělo vyšší hodnocení než "skauting mě v tom rozvíjí"

```{r}
rozdil_rozvijim_skauting <- expanded %>% select(session, kategorie_kompetence, kompetence_odpoved, kompetence) %>% filter(kategorie_kompetence %in% c("rozvijim","skauting")) %>%
  pivot_wider(id_cols = c("session", "kompetence"), names_from = kategorie_kompetence, values_from = kompetence_odpoved) %>%
  mutate(rozdil_rozvijim_skauting = rozvijim - skauting) %>%
  filter(!is.na(rozdil_rozvijim_skauting))


rozdil_rozvijim_skauting %>%
  group_by(kompetence) %>%
  summarise(prumer_rozdil = mean(rozdil_rozvijim_skauting, na.rm = TRUE), pocet = sum(!is.na(rozdil_rozvijim_skauting))) %>%
  arrange(desc(prumer_rozdil))


```

```{r}
rozdil_rozvijim_skauting %>%
  ggplot(aes(rozdil_rozvijim_skauting)) +
    geom_histogram(binwidth = 1) + facet_wrap(~kompetence) +
    geom_vline(xintercept = 0, color = "gray") +
    theme(strip.text = element_text(size = 8))
```

```{r}

```

