---
title: "Odchody lidí v roverském věku"
output: html_notebook
author: "Martin 'Orel' Modrák"
date: '`r format(Sys.time(), "%d %B, %Y")`'
---

```{r setup, message=FALSE}
knitr::opts_chunk$set(echo=FALSE)
library(lubridate)
library(readxl)
library(tidyverse)
library(forcats)
library(here)
library(bindrcpp)
library(brms)
options(mc.cores=parallel::detectCores())
library(cowplot)

source(here::here("R","data_registrace_jednotlivci.R"), encoding = "UTF-8")
source(here::here("R","tools_brms.R"))

tolerovana_prestavka <- 0
min_rok <- 2012
min_vek <- 6
max_vek <- 21
```

```{r}
registrace <- registrace_jednotlivci() %>% rename(Sex = ID_Sex)
```


```{r}
posledni_rok <- max(registrace$Year)
cat("Zpracováváme data od roku",min_rok,"do roku", posledni_rok)
```

Všude bereme že věk = rok registrace - rok narození.

```{r}
zacatky <- function(x, tolerovana_prestavka) {
  sorted <- sort(x)
  sorted_diff <- diff(sorted)
  sorted[c(TRUE, sorted_diff > tolerovana_prestavka + 1)]  
}

konce <- function(x, tolerovana_prestavka) {
  sorted <- sort(x)
  sorted_diff <- diff(sorted)
  sorted[c(sorted_diff > tolerovana_prestavka + 1, TRUE)]  
}

#Rychle testy, jestli funkce funguje
stopifnot(all(konce(c(2008,2005,2006,2007), 1) == 2008))
stopifnot(all(konce(c(2008,2005,2006,2007), 0) == 2008))
stopifnot(all(konce(c(2008,2005), 1) == c(2005,2008)))
stopifnot(all(konce(c(2008,2005), 2) == 2008))
stopifnot(all(konce(c(2008,2006), 1) == 2008))
stopifnot(all(konce(c(2008,2006), 0) == c(2006,2008)))
stopifnot(all(konce(c(2008,2001,2002,2005,2006,2007), 1) == c(2002,2008)))
stopifnot(all(konce(c(2008,2001,2002,2005,2006,2007,2011,2012), 1) == c(2002,2008,2012)))
stopifnot(all(konce(c(2008,2002,2003,2005,2001,2006,2007,2011,2012), 1) == c(2008,2012)))
stopifnot(all(konce(c(2008,2001,2002,2003,2005,2006,2007,2011,2012), 0) == c(2003,2008,2012)))


stopifnot(all(zacatky(c(2008,2006), 1) == 2006))
stopifnot(all(zacatky(c(2008,2001,2002,2005,2006,2007,2011,2012), 1) == c(2001,2005,2011)))
stopifnot(all(zacatky(c(2008,2002,2003,2005,2001,2006,2007,2011,2012), 1) == c(2001,2011)))
stopifnot(all(zacatky(c(2008,2001,2002,2003,2005,2006,2007,2011,2012), 0) == c(2001,2005,2011)))

```

Zkontroluji, jak časté jsou přestávky v členství

```{r}

rozsah_clenstvi <- registrace %>%
  group_by(Person_PseudoID) %>%
  summarise(rok_narozeni = unique(rok_narozeni), Sex = unique(Sex),
            
            prvni_registrace = min(Year), posledni_registrace = max(Year), 
            prvni_konec = min(konce(Year, tolerovana_prestavka = tolerovana_prestavka)),
            konec_do_12_let = any(konce(Year, tolerovana_prestavka = tolerovana_prestavka) - rok_narozeni <= 12),
            konec_13_az_16_let = any(between(konce(Year, tolerovana_prestavka = tolerovana_prestavka) - rok_narozeni, 13, 16)),
            prestavky_celkem_let =  (posledni_registrace - prvni_registrace + 1) - length(unique(Year)),
            pocet_prestavek = sum(diff(sort(Year)) > 1)
            ) 


```


```{r}
rozsah_clenstvi %>% group_by(pocet_prestavek) %>% summarise(pocet_osob = length(rok_narozeni))
rozsah_clenstvi %>% group_by(prestavky_celkem_let) %>% summarise(pocet_osob = length(rok_narozeni))
cat("Počet členů kteří odešli do 12 let a pak znovu do 16ti let:", sum(rozsah_clenstvi$konec_do_12_let & rozsah_clenstvi$konec_13_az_16_let))
```

Bohužel je tu dost lidí, kteří odešli vícekrát a to i ve věku, který nás zajímá. Budeme tedy zvlášť analyzovat první odchody a poslední odchody.
V této analýze bereme neregistraci jako konec členství. Výsledky jsou ale podobné i když vezmeme jednoroční přestávku jako souvislé členství.


```{r}
odchazeni <- 
  registrace %>%
  mutate(vek = Year - rok_narozeni) %>%
  filter(Year >= min_rok, Year < posledni_rok - tolerovana_prestavka, vek >= min_vek & vek <= max_vek) %>%
  inner_join(rozsah_clenstvi %>% select(-rok_narozeni, -Sex), by = c("Person_PseudoID" = "Person_PseudoID")) %>%
  mutate(delka_clenstvi = Year - prvni_registrace + 1)

odchazeni_posledni <- odchazeni %>%
  mutate(ukonceno = Year == posledni_registrace) 

odchazeni_prvni <- odchazeni %>%
  filter(Year <= prvni_konec) %>%
  mutate(ukonceno = Year == prvni_konec) 

```


## Poslední odchody

Zde vidíme, jaká část členské základny Junáka daného věku odešla během sledovaného období (tj. kdyby za toto období bylo v Junáku celkem 1000 chlapců během svých 13ti let a z toho jich 200 ve 13ti odešlo, bude zde 0.2). Pruh kolem údajů ukazuje očekávanou nejistotu (vychází z celkového počtu členů v kategorii). Sledujeme poslední odchody, tj. rok, kdy se naposledy registrovali. 


```{r}
sumar_odchodu <- function(odchazeni, by = "none") {
  if(by == "year") {
    group_var <- quo(Year)
  } else if(by == "delka_clenstvi") {
    odchazeni <- odchazeni %>% mutate(delka_clenstvi_cat = case_when(
      delka_clenstvi >= 4 ~ "4 a více let",
      delka_clenstvi >= 2 ~ "2-3 roky",
      TRUE ~ "1 rok"))
    group_var <- quo(delka_clenstvi_cat)
  } else if(by == "none") {
    group_var <- quo(1)
  } else {
    stop("Neplatné by.")
  }
  
  odchazeni %>%
    group_by(vek, Sex, !! group_var) %>%
    summarise(n_ukonceno = sum(ukonceno), pocet = length(Person_PseudoID)) %>%
    ungroup() %>%
    mutate(podil_odchazejicich = n_ukonceno / pocet,
           lower = qbeta(0.025, n_ukonceno + 1, pocet - n_ukonceno + 1),
           upper = qbeta(0.975, n_ukonceno + 1, pocet - n_ukonceno + 1)
           )
}

plot_odchody <- function(odchazeni, by = "none") {

  if(by == "year") {
    facet <- facet_wrap( ~ Year)
  } else if(by == "delka_clenstvi") {
    facet <- facet_wrap( ~ delka_clenstvi_cat, nrow = 1)
  } else if(by == "none") {
    facet <- NULL
  } else {
    stop("Neplatné by.")
  }


  sumar_odchodu(odchazeni, by) %>% 
    ggplot(aes(x = vek, y = podil_odchazejicich, ymin = lower, ymax = upper, fill = Sex)) + 
    geom_ribbon(alpha = 0.1) +
    geom_vline(xintercept = 15, size = 1, linetype = "dashed", color = "gray") +
    geom_line(aes(color = Sex)) +
    facet

}
plot_odchody(odchazeni_posledni)
```

Zdá se tedy, že z Junáka odchází během skautského věku poměrně rovnoměrně kolem 18% členů z ročníku (chlapců o něco víc). To odpovídá "poločasu rozpadu" pro skauty cca 3.5 roku. Po 15tém roce se toto číslo nezvyšuje, naopak klesá. Nezdá se tedy, že by 15tý rok byl více zlomový pro členství než jiné roky.

Pro jistotu se podívejme zvlášť na každý rok. Opět vidíme podíl členů, kteří odešli v daném roce a věku (tj. když v roce 2006 měl Junáka 5000 dvanáctiletých děvčat a 500 dvanáctiletých děvčat ten rok odešlo, bude uvedeno 0.1).


```{r}
plot_odchody(odchazeni_posledni, "year")
```

```{r}
spicka_2015 <- odchazeni_posledni %>% filter(Year == 2015, vek == 16, Sex == "male") %>%
  summarise(n_ukonceno = sum(ukonceno), pocet = length(Person_PseudoID))
avg_16 <- odchazeni_posledni %>% filter(vek == 16, Year != 2015, Sex == "male") %>%
  summarise(n_ukonceno = sum(ukonceno), pocet = length(Person_PseudoID), podil = n_ukonceno/pocet)
```


Trend ve všech letech víceméně podobný - žádná výrazná změna kolem 15tého roku. Výjimkou je zvláštní špička v roce 2015, kdy z `r spicka_2015$pocet` šestnácti letých chlapců odešlo `r spicka_2015$n_ukonceno` zatímco při průměrné míře odchodu by to bylo cca `r round(spicka_2015$pocet * avg_16$podil)`. Tuto špičku neumím vysvětlit, ale může to být klidně jen náhoda.

Data mají mírně sestupný trend v čase (tj. poslední dobou méně lidí odchází) ale nutno podotknout, že zde očekáváme sestupný trend v čase i kdyby se nic neměnilo - část lidí se do Junáka vrací a ti z posledních let kteří se v budoucnu vrátí jsou v grafu vedeni jako ztracení.

## První odchody

Pro jistotu se podíváme na ty samé grafy, ale s prvními odchody, tj. kdy poprvé měl člověk v pauzu v registraci. Ti, kteří se pak vrátili jsou počítáni pouze ke svému prvnímu odchodu.

```{r}
plot_odchody(odchazeni_prvni)
plot_odchody(odchazeni_prvni, "year")

```

Vidíme, že trendy v prvních odchodech jsou velmi podobné jako v posledních odchodech, dál bereme tedy poslední odchody.

## Poslední odchody, dlouhodobí členové

V grafech výše  se spíše nevyskytuje žádná špička u přechodu do roverského věku. Ale vidíme, že odchází celkem hodně lidí (cca pětina ročníku). To budou asi lidé, kteří se registrovali jen krátce. Podíváme se tedy, jestli to vypadá stejně u členů, kteří již chodili déle. Údaje jsou relativní k celkovému počtu dlouhodobých členů v té době registrovaných.


```{r}
odchazeni_posledni_novacci <- odchazeni_posledni %>% filter(vek >= 10, delka_clenstvi == 1)  
odchazeni_posledni_2_roky <- odchazeni_posledni %>% filter(vek >= 10, delka_clenstvi >= 2)  
odchazeni_posledni_4_roky <- odchazeni_posledni %>% filter(vek >= 10, delka_clenstvi >= 4)  
plot_odchody(odchazeni_posledni_novacci)
plot_odchody(odchazeni_posledni_novacci,"year")
plot_odchody(odchazeni_posledni_2_roky)
plot_odchody(odchazeni_posledni_2_roky, "year")
plot_odchody(odchazeni_posledni_4_roky)
plot_odchody(odchazeni_posledni_4_roky, "year")
```


```{r}
plot_odchody(odchazeni_posledni_2_roky %>% filter(Year >= 2016))

```

# Příchody nováčků

```{r}
sumar_prichody <- function(odchazeni, by = "none", response = podil_novych) {
  response <- enquo(response)
  if(by == "year") {
    group_var <- quo(Year)
  } else if(by == "none") {
    group_var <- quo(1)
  } else {
    stop("Neplatné by.")
  }
  
  odchazeni %>%
    group_by(vek, Sex, !! group_var) %>%
    summarise(n_novych = sum(prvni_registrace == Year), pocet = length(Person_PseudoID)) %>%
    ungroup() %>%
    mutate(podil_novych = n_novych / pocet
           )
}

plot_prichody <- function(odchazeni, by = "none", response = podil_novych) {
  
  if(by == "year") {
    facet <- facet_wrap( ~ Year)
  } else if(by == "none") {
    facet <- NULL
  } else {
    stop("Neplatné by.")
  }  
  
  response <- enquo(response)

  sumar_prichody(odchazeni, by, !! response) %>% 
    ggplot(aes(x = vek, y = !! response)) + 
    geom_vline(xintercept = 15, size = 1, linetype = "dashed", color = "gray") +
    geom_line(aes(color = Sex)) +
    facet

}
plot_prichody(odchazeni_posledni)
```


```{r}
plot_prichody(odchazeni_posledni, response = n_novych)

plot_prichody(odchazeni_posledni, by = "year")
```

```{r}
sumar_pocty <- function(odchazeni, by = "none") {
  if(by == "year") {
    group_var <- quo(Year)
  } else if(by == "none") {
    group_var <- quo(1)
  } else {
    stop("Neplatné by.")
  }
  
  odchazeni %>%
    group_by(vek, Sex, !! group_var) %>%
    summarise(pocet = length(Person_PseudoID)) %>%
    ungroup() 
}

plot_pocty <- function(odchazeni, by = "none") {
  if(by == "year") {
    facet <- facet_wrap( ~ Year)
  } else if(by == "none") {
    facet <- NULL
  } else {
    stop("Neplatné by.")
  }

  sumar_pocty(odchazeni, by) %>% 
    ggplot(aes(x = vek, y = pocet)) + 
    geom_vline(xintercept = 15, size = 1, linetype = "dashed", color = "gray") +
    geom_line(aes(color = Sex)) +
    facet

}
plot_pocty(odchazeni_posledni)

```

```{r}
plot_pocty(odchazeni_posledni %>% filter(delka_clenstvi >= 2))
plot_pocty(odchazeni_posledni, by = "year")
```

```{r}
optimisticky_odhad_zmeny <- 0.03
optimisticky_odhad_poctu_2016 <- odchazeni %>% filter(Year == 2016 & (vek == 14)) %>% 
  summarise(pocet  = length(Person_PseudoID), zustavsi =  pocet * (optimisticky_odhad_zmeny + optimisticky_odhad_zmeny ^ 2)) 
optimisticky_odhad_poctu_2017 <- odchazeni %>% filter(Year == 2017 & (vek == 15)) %>% 
  summarise(pocet  = length(Person_PseudoID), zustavsi =  pocet * (optimisticky_odhad_zmeny)) 
optimisticky_odhad_poctu <- optimisticky_odhad_poctu_2016$zustavsi + optimisticky_odhad_poctu_2017$zustavsi
optimisticky_odhad_poctu
```

TODO: Odchody novacci, starsi - udelat facety
+ vysypat konkrétní čísla


# Analýza s modelem

```{r}
rozsah_clenstvi %>% 
  filter(posledni_registrace >= min_rok, posledni_registrace < posledni_rok - tolerovana_prestavka, prvni_registrace > 2003) %>%
  ggplot(aes(x=posledni_registrace - prvni_registrace)) + geom_histogram(binwidth = 1)
```

