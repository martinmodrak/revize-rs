---
title: "Odchody lidí v roverském věku"
output: html_notebook
author: "Martin 'Orel' Modrák"
date: '`r format(Sys.time(), "%d %B, %Y")`'
---

```{r setup, message=FALSE}
knitr::opts_chunk$set(echo=FALSE)
library(lubridate)
library(readxl)
library(tidyverse)
library(forcats)
library(here)
library(bindrcpp)

source(here("R","data_registrace_jednotlivci.R"), encoding = "UTF-8")
```

```{r}
registrace <- registrace_jednotlivci()
```


```{r}
cat("Zpracováváme data od roku",min(registrace$Year),"do roku", max(registrace$Year))
posledni_rok <- max(registrace$Year)
```

Všude bereme že věk = rok registrace - rok narození.

```{r}
zacatky <- function(x, tolerovana_prestavka) {
  sorted <- sort(x)
  sorted_diff <- diff(sorted)
  sorted[c(TRUE, sorted_diff > tolerovana_prestavka + 1)]  
}

konce <- function(x, tolerovana_prestavka) {
  sorted <- sort(x)
  sorted_diff <- diff(sorted)
  sorted[c(sorted_diff > tolerovana_prestavka + 1, TRUE)]  
}

#Rychle testy, jestli funkce funguje
stopifnot(all(konce(c(2008,2005,2006,2007), 1) == 2008))
stopifnot(all(konce(c(2008,2005,2006,2007), 0) == 2008))
stopifnot(all(konce(c(2008,2005), 1) == c(2005,2008)))
stopifnot(all(konce(c(2008,2005), 2) == 2008))
stopifnot(all(konce(c(2008,2006), 1) == 2008))
stopifnot(all(konce(c(2008,2006), 0) == c(2006,2008)))
stopifnot(all(konce(c(2008,2001,2002,2005,2006,2007), 1) == c(2002,2008)))
stopifnot(all(konce(c(2008,2001,2002,2005,2006,2007,2011,2012), 1) == c(2002,2008,2012)))
stopifnot(all(konce(c(2008,2002,2003,2005,2001,2006,2007,2011,2012), 1) == c(2008,2012)))
stopifnot(all(konce(c(2008,2001,2002,2003,2005,2006,2007,2011,2012), 0) == c(2003,2008,2012)))


stopifnot(all(zacatky(c(2008,2006), 1) == 2006))
stopifnot(all(zacatky(c(2008,2001,2002,2005,2006,2007,2011,2012), 1) == c(2001,2005,2011)))
stopifnot(all(zacatky(c(2008,2002,2003,2005,2001,2006,2007,2011,2012), 1) == c(2001,2011)))
stopifnot(all(zacatky(c(2008,2001,2002,2003,2005,2006,2007,2011,2012), 0) == c(2001,2005,2011)))

```

Zkontroluji, jak časté jsou přestávky v členství

```{r}
tolerovana_prestavka <- 1

rozsah_clenstvi <- registrace %>%
  group_by(Person_PseudoID) %>%
  summarise(rok_narozeni = unique(rok_narozeni), ID_Sex = unique(ID_Sex),
            
            prvni_registrace = min(Year), posledni_registrace = max(Year), 
            prvni_konec = min(konce(Year, tolerovana_prestavka = 1)),
            konec_do_12_let = any(konce(Year, tolerovana_prestavka = 1) - rok_narozeni <= 12),
            konec_13_az_16_let = any(between(konce(Year, tolerovana_prestavka = 1) - rok_narozeni, 13, 16)),
            prestavky_celkem_let =  (posledni_registrace - prvni_registrace + 1) - length(unique(Year)),
            pocet_prestavek = sum(diff(sort(Year)) > 1)
            )

```


```{r}
rozsah_clenstvi %>% group_by(pocet_prestavek) %>% summarise(pocet_osob = length(rok_narozeni))
rozsah_clenstvi %>% group_by(prestavky_celkem_let) %>% summarise(pocet_osob = length(rok_narozeni))
cat("Počet členů kteří odešli do 12 let a pak znovu do 16ti let:", sum(rozsah_clenstvi$konec_do_12_let & rozsah_clenstvi$konec_13_az_16_let))
```

Pro další analýzy budeme brát přestávku jednoho roku jako souvislé členství. 
Bohužel je tu (po započítání přestávky) tedy dost lidí, kteří odešli vícekrát a to i ve věku, který nás zajímá. Budeme tedy zvlášť analyzovat první odchody a poslední odchody.

```{r}
pocty_clenu_rok_vek_pohlavi <- registrace %>%
  group_by(Year, vek, ID_Sex) %>% 
  summarise(pocet_clenu_v_kategorii = length(unique(Person_PseudoID)))
```


## Poslední odchody

Zde vidíme, jaká část členské základny Junáka daného věku odešla v daném roce (tj. když v roce 2006 měl Junáka 5000 dvanáctiletých děvčat a 500 dvanáctiletých děvčat ten rok odešlo, bude uvedeno 0.1). Sledujeme poslední odchody, tj. rok, kdy se naposledy registrovali. 


```{r}
plot_odchody <- function(odchody, pocty_clenu_rok_vek_pohlavi, additional_info = NULL) {
if(is.null(additional_info)) {
  odchody$kategorie = odchody$ID_Sex
} else 
{
  odchody$kategorie = factor(paste(odchody$ID_Sex, additional_info))
}

  sumar_odchodu <- odchody %>% 
  group_by(ID_Sex, kategorie, vek_odchodu, rok_odchodu) %>%
  summarise(pocet_odeslych = length(Person_PseudoID)) %>%
  inner_join(pocty_clenu_rok_vek_pohlavi, by = c("vek_odchodu" = "vek", "rok_odchodu" = "Year", "ID_Sex" = "ID_Sex")) %>% 
  mutate(podil_odchazejicich = pocet_odeslych / pocet_clenu_v_kategorii)


sumar_odchodu %>% filter(vek_odchodu >= 9, vek_odchodu <= 21, rok_odchodu > 2010) %>%
  ggplot(aes(x = vek_odchodu, y = podil_odchazejicich, color = kategorie)) + geom_line() + 
  facet_wrap(~ rok_odchodu)

}

```


```{r}
posledni_odchody <- rozsah_clenstvi %>%
  filter(posledni_registrace < posledni_rok - tolerovana_prestavka) %>%
  mutate(vek_odchodu = posledni_registrace - rok_narozeni, rok_odchodu = posledni_registrace)

plot_odchody(posledni_odchody, pocty_clenu_rok_vek_pohlavi)

```
Data mají sestupný trend v čase (tj. poslední dobou méně lidí odchází) ale nutno podotknout, že zde očekáváme sestupný trend v čase i kdyby se nic neměnilo - část lidí se do Junáka vrací a ti z posledních let kteří se v budoucnu vrátí jsou v grafu vedeni jako ztracení. Neukazují ale výrazný vrchol kolem 15tého roku.

## První odchody

Můžeme se ještě podívat na první odchody, tj. kdy poprvé měl člověk v členství delší pauzu dvou let. Ti, kteří se pak vrátili jsou počítáni pouze ke svému prvnímu odchodu.


```{r}
prvni_odchody <- rozsah_clenstvi %>%
  filter(prvni_konec < posledni_rok - tolerovana_prestavka) %>%
  mutate(vek_odchodu = prvni_konec - rok_narozeni, rok_odchodu = prvni_konec)

plot_odchody(prvni_odchody, pocty_clenu_rok_vek_pohlavi)

```

Vidíme, že trendy v prvních odchodech jsou velmi podobné jako v posledních odchodech, dál bereme tedy poslední odchody.

## Poslední odchody, dlouhodobí členové

V grafech výše  se spíše nevyskytuje žádná špička u přechodu do roverského věku. Ale vidíme, že odchází celkem hodně lidí (až čtvrtina ročníku). To budou asi lidé, kteří se registrovali jen krátce. Zaměříme se tedy jen na ty, kteří chodili do Junáka alespoň dva roky. A ještě si dáme zvlášť ty, co chodili 4 a více let - to už jsou zkušení členové. Údaje jsou relativní k celkovému počtu dlouhodobých členů v té době registrovaných.


```{r}
plot_odchody_minimalni_delka <- function(posledni_odchody, registrace, minimalni_delka_clenstvi) {

  posledni_odchody_2_roky <- posledni_odchody %>%
    mutate(roku_clenstvi = posledni_registrace - prvni_registrace - prestavky_celkem_let) %>%
    filter(roku_clenstvi >= minimalni_delka_clenstvi) 
  
  pocty_clenu_rok_vek_pohlavi_2_roky <- registrace %>%
    inner_join(rozsah_clenstvi %>% select(Person_PseudoID,prvni_registrace), by = c("Person_PseudoID" = "Person_PseudoID") ) %>%
    filter(Year - prvni_registrace >= minimalni_delka_clenstvi) %>%
    group_by(Year, vek, ID_Sex) %>% 
    summarise(pocet_clenu_v_kategorii = length(unique(Person_PseudoID)))
  
  
  plot_odchody(posledni_odchody_2_roky, pocty_clenu_rok_vek_pohlavi_2_roky) + ggtitle(paste("Členství alespoň ", minimalni_delka_clenstvi, "roky"))
}

plot_odchody_minimalni_delka(posledni_odchody, registrace, 2)
plot_odchody_minimalni_delka(posledni_odchody, registrace, 4)
```

U dlouhodobějších členů lze najít vrchol někde kolem 15 roku věku, ale zejména u opravdu dlouhodobých členů se nezdá velmi výrazný (tedy vzhledem k odchodům během skautských let). Je nicméně hloupé, že ty jzkušenější nejspíš skutečně ztrácíme v přechodu do roverského věku o něco víc.
