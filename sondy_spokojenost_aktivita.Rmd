---
title: "Spokojenost a aktivita roverů v datech ze sond"
output: html_document
author: "Martin 'Orel' Modrák"
date: '`r format(Sys.time(), "%d %B, %Y")`'
---

_Kompletní kód analýzy je k nalezení na https://github.com/martinmodrak/revize-rs _

# Otázka, kterou chceme zodpovědět

Jsou v datech ze sond do roveringu nějaké zajímavé vztahy mezi tím, jak kmen funguje a dalšími ukazateli a spokojeností roverů či aktivitou jejich kmene?

# Shrnutí výsledků

V první řadě je potřeba zdůraznit, že všechny závěry je třeba brát s rezervou. V datech jako jsou sondy nelze rozlišit, co je příčina co je následek. Ne všichni taky odpověděli na všechny otázky a data mají i další drobné problémy. Ukazuje nám to ale nějaké zajímavé vzorce, které mohou být zajímavé pro další zkoumání/přemýšlení. Zároven jsou roveři různorodí a všechny asociace jsou dost slabé.

Spokojenost i aktivita roverů se zdá (nepřekvapivě) být nejvíc asociována s počtem členů v kmeni (čím víc, tím spokojenější/aktivnější kmen). Spokojenost má též negativní asociaci s věkem (čím starší, tím méně spokojený), u aktivity to ale spíše nepozorujeme. Kmeny, které mají vůdce jsou také v průměru spokojenější i aktivnější, zatímco mít kmenovou radu je v sondách spojeno jen s nárůstem aktivity a ne se zvýšenou spokojeností. 

Slabší  asociaci jsme také našli u toho, kdo připravuje program - příprava programu pouze v úzké skupině je spojena s nižší aktivitou zatímco nejvyšší aktivitu jsme viděli u kmenů, kde program připravuju hlavně vůdce. Program připravovaný hlavně vůdcem je ale spojen s nižší spokojeností zatímce ve kmenech, kde je vyšší spokojenost se na přípravě spíše podílejí všichni.

Roveři v menších městech se zdají být méně aktivní, ale podobně spokojení.

Naopak jsme NEpozorovali asociaci s délkou fungování kmene

```{r setup, message=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo=FALSE)
library(tidyverse)
library(brms)
library(scico)
library(here)
library(cowplot)
library(bindrcpp)
options(mc.cores=parallel::detectCores())
Sys.setlocale(locale = "Czech")
source(here::here("R","tools_brms.R"), encoding = "UTF-8")
source(here::here("R","tools_spokojenost_aktivita.R"), encoding = "UTF-8")
```

```{r}
if(!file.exists("private_data/sondy_181101.rds")) {
  stop("Nenalezena predzpracovana data ze sond. Spust sondy_prepare_data.R")
}
sondy <- readRDS("private_data/sondy_181101.rds")

sondy <- sondy %>%
  filter(q0_clen_junaka == "Ano") %>%
  mutate(
    max_funkce = if_else(
      q0_vedouci_strediska == "Ano", "vudce_strediska", if_else(
        q0_vudce_oddilu == "Ano", "vudce_oddilu",if_else(
          q0_vudce_rs_kmene == "Ano", "vudce_kmene", if_else(
            funkce_v_oddile_zastupce_VO == "Ano", "zastupce_v_oddilu", if_else(
              funkce_v_oddile_oddilovy_radce == "Ano", "oddilovy_radce", if_else(
                funkce_v_oddile_druzinovy_radce == "Ano", "druzinovy_radce", if_else(

                  q0_ve_vedeni_oddilu == "Ano" | funkce_v_oddile_clen_vedeni_oddilu == "Ano", "sirsi_vedeni_oddilu", "nic"
    ))))))),
    max_funkce = fct_relevel(max_funkce, "vudce_strediska", "vudce_oddilu", "vudce_kmene", "zastupce_v_oddilu", "oddilovy_radce","druzinovy_radce","sirsi_vedeni_oddilu"),
    max_funkce_v_kmeni = case_when(
      rs_kmen_moje_funkce_vudce == "Ano" ~ "vudce",
      rs_kmen_moje_funkce_rada == "Ano" ~ "rada",
      !is.na(rs_kmen_moje_funkce_jine) ~ "jine",
      rs_kmen_moje_funkce_clen == "Ano" ~ "clen",
      TRUE ~ "zadna"
    ),
    max_funkce_v_kmeni = fct_relevel(max_funkce_v_kmeni, "vudce","rada","jine","clen", "zadna"),
    celkova_spokojenost_s_programem_rs_kmenu = fct_relevel(celkova_spokojenost_s_programem_rs_kmenu, "Velmi nespokojen/a", "Spíše nespokojen/a","Spíše spokojen/a","Velmi spokojen/a"),
    kdo_pripravuje_program = fct_recode(vyrok_o_spolecenstvi, uzka_skupina = "Program připravuje úzká skupina lidí", vsichni =  "Na přípravě programu se podílí různí členové podle toho, o jakou činnost se jedná.", vudce =  "Program připravuje vůdce/vůdkyně kmene nebo roverského společenství"   ),
    studium_ve_meste_strediska = fct_recode(studium_ve_meste_strediska, Ne = "Ne, většinu roku trávím mimo místo, kde mám svoje středisko")
  )
```

Nejprve několik poznám

```{r model_spokojenost, message=FALSE}

zakladni_data_pro_model <- sondy %>% 
  filter(!is.na(kolik_let_rs_kmen_funguje), !is.na(kmen_kolik_aktivnich_lidi), !is.na(vek)) %>%
  mutate(
    celkova_spokojenost_int = as.integer(celkova_spokojenost_s_programem_rs_kmenu),
    kmen_kolik_aktivnich_lidi_orig = kmen_kolik_aktivnich_lidi,
    kolik_let_rs_kmen_funguje_orig = kolik_let_rs_kmen_funguje,
    vek_orig = vek,
    kmen_kolik_aktivnich_lidi = std_normalize(kmen_kolik_aktivnich_lidi),
    kolik_let_rs_kmen_funguje = std_normalize(kolik_let_rs_kmen_funguje),
    vek = std_normalize(vek),
    pohlavi = if_else(pohlavi == "N/A", "Neuvedeno", pohlavi),
    je_ve_meste_univerzita = if_else(je_ve_meste_univerzita == "N/A", "Neuvedeno", je_ve_meste_univerzita),
    kraj = replace_na(kraj),
    velikost_obce = replace_na(velikost_obce),
    pocet_obyvatel_kde_stredisko = replace_na(pocet_obyvatel_kde_stredisko),
    studium_ve_meste_strediska = replace_na(studium_ve_meste_strediska), 
    je_vice_rs_kmenu_ve_stredisku = replace_na(je_vice_rs_kmenu_ve_stredisku),
    je_rs_kmen_registrovany = replace_na(je_rs_kmen_registrovany),
    povazujes_se_za_rovera = replace_na(povazujes_se_za_rovera),
    kdo_pripravuje_program = replace_na(kdo_pripravuje_program),
    povazujes_se_za_rovera = replace_na(fct_recode(povazujes_se_za_rovera, Ano = "Ano, považuji se za rovera/rangers", Ne_ale_budu = "Ne, nyní se nepovažuji za rovera/rangers, ale myslím, že rover/rangers budu", Ne_ale_byl =  "Ne, nyní se nepovažuji za rovera/rangers, ale dříve jsem byl/a"))
    )

normalized_translator_aktivni_lide <- normalized_translator(zakladni_data_pro_model$kmen_kolik_aktivnich_lidi_orig)
normalized_translator_let_funguje <- normalized_translator(zakladni_data_pro_model$kolik_let_rs_kmen_funguje_orig)
normalized_translator_vek <- normalized_translator(zakladni_data_pro_model$vek_orig)

spokojenost_pro_model <- zakladni_data_pro_model %>%
  filter(!is.na(celkova_spokojenost_s_programem_rs_kmenu))

# predictor_matrix <- matrix(0, nrow = 3, ncol = ncol(spokojenost_pro_model))
# colnames(predictor_matrix) <- names(spokojenost_pro_model)
# predictor_matrix[, c("kmen_kolik_aktivnich_lidi","kolik_let_rs_kmen_funguje", "je_rs_kmen_registrovany", "je_ve_meste_univerzita")] <- 1
# predictor_matrix[3,c("frekvence_rs_akci_celodenni_akce","frekvence_rs_akci_schuzky",
#                                             "frekvence_rs_akci_vicedenni_akce","frekvence_rs_akci_tabory_expedice")] <- 1


# spokojenost_imputed <- mice(spokojenost_pro_model, 
#                             blocks = list("kmen_kolik_aktivnich_lidi","kolik_let_rs_kmen_funguje", 
#                                           c("frekvence_rs_akci_celodenni_akce","frekvence_rs_akci_schuzky",
#                                             "frekvence_rs_akci_vicedenni_akce","frekvence_rs_akci_tabory_expedice")),
#                             predictorMatrix = predictor_matrix)
cat("Pro model spokojenosti je dostupných ", nrow(spokojenost_pro_model), "řádků (",nrow(spokojenost_pro_model)/nrow(sondy), ")\n")


formula_spokojenost <- brmsformula(celkova_spokojenost_int ~ kmen_kolik_aktivnich_lidi + kolik_let_rs_kmen_funguje + vek + (1|| pohlavi + rs_kmen_prvky_vudce + rs_kmen_prvky_rada + max_funkce + max_funkce_v_kmeni + je_ve_meste_univerzita + studium_ve_meste_strediska + je_vice_rs_kmenu_ve_stredisku + je_rs_kmen_registrovany + povazujes_se_za_rovera + kdo_pripravuje_program + kraj + velikost_obce),
                                   family = cumulative("logit"))

#get_prior(formula_spokojenost, data = spokojenost_pro_model)
priors <- c(prior(normal(0,1), class = "b"),#prior(horseshoe(par_ratio = 0.3), class = "b"),
            prior(normal(0,1), class = "sd"))
#priors <- prior(normal(0,1), class = "b")

#make_stancode(formula_spokojenost, data = spokojenost_pro_model, prior = priors) 
fit_spokojenost <- brm(formula_spokojenost, data = spokojenost_pro_model, prior = priors, control = list(adapt_delta = 0.99), file = here::here("local_data","fit_spokojenost"))

```

```{r}
#pomocne nastroje pro ploteni spokojenosti
continous_var_labels <- function(var_values) {
  labels <- as.character(var_values)
  labels[length(labels)] <- paste0(labels[length(labels)], "+")
  labels
}

effects_by_prediction_spokojenost <- function(var_name, var_values = levels(spokojenost_pro_model[[var_name]]), var_labels = var_values, order = FALSE, n_samples = 500, max_lines = 200) {
  
  num_low_categories <- 2
  
  data_with_response <-  spokojenost_pro_model %>% mutate(response_positive = (celkova_spokojenost_int > num_low_categories))
  
  if(order) {
    order_perm <- order_by_response_positive(data_with_response, var_name, var_values)
    var_values = var_values[order_perm]
    var_labels = var_labels[order_perm]
  }
  
  effects_by_prediction(fit_spokojenost, 
                        data_with_response, 
                        var_name, 
                        var_values, 
                        var_labels = var_labels,
                        response_to_value_func = function(x) {1 - sum(x[1:num_low_categories])}, 
                        response_title = "P(spíše spokojen než ne)",
                        n_samples = n_samples,
                        max_lines = max_lines)
}
```


Aktivita - vyhodime, kdo nevyplnil vse, pokud vyplnil aspon jedno, dame vsude jinde "Nikdy"


```{r model_aktivita}
aktivita_pro_model <- zakladni_data_pro_model %>%
  filter(!is.na(frekvence_rs_akci_schuzky) || !is.na(frekvence_rs_akci_celodenni_akce) || !is.na(frekvence_rs_akci_vicedenni_akce) || !is.na(frekvence_rs_akci_tabory_expedice)) %>%
  mutate(    
    frekvence_rs_akci_celodenni_akce = recode_frekvence(frekvence_rs_akci_celodenni_akce),
    frekvence_rs_akci_schuzky = recode_frekvence(frekvence_rs_akci_schuzky),
    frekvence_rs_akci_vicedenni_akce = recode_frekvence(frekvence_rs_akci_vicedenni_akce),
    frekvence_rs_akci_tabory_expedice = recode_frekvence(frekvence_rs_akci_tabory_expedice)
 )

cat("Pro model dostupných ", nrow(aktivita_pro_model), "řádků (",nrow(aktivita_pro_model)/nrow(sondy), ")\n")


formula_aktivita <- update.formula(formula_spokojenost, cbind(frekvence_rs_akci_schuzky, frekvence_rs_akci_celodenni_akce, frekvence_rs_akci_vicedenni_akce, frekvence_rs_akci_tabory_expedice) ~ .)
#formula_aktivita <- update.formula(formula_spokojenost, frekvence_rs_akci_celodenni_akce ~ .)

response_names <- 
  c("frekvence_rs_akci_celodenni_akce","frekvence_rs_akci_schuzky","frekvence_rs_akci_vicedenni_akce", "frekvence_rs_akci_tabory_expedice") %>%
  #"" %>%
  gsub("_","", ., fixed = TRUE)

priors_multivar <- 
  response_names %>%
  map(function(resp) { c(set_prior("normal(0,1)", class = "b", resp = resp),#prior(horseshoe(par_ratio = 0.3), class = "b"),
            set_prior("normal(0,1)", class = "sd", resp = resp)) }) %>% do.call(c, .)


fit_aktivita <- brm(formula_aktivita, data = aktivita_pro_model, prior = priors_multivar, control = list(adapt_delta = 0.95), family = cumulative("logit"), file = here::here("local_data","fit_aktivita")) 

```

```{r}
# Tvrdime, ze kmen je aktivni, kdyz ma schuzky >= 7 (jednou za 14 dni) NEBO celodenky >= 6 (jednou mesicne) NEBO vicedenky >= 5 (jednou za 1/4 roku) NEBO tabory/expedice >= 4 (jednou za pul roku).
effects_by_prediction_aktivita <- function(var_name, var_values = levels(aktivita_pro_model[[var_name]]), var_labels = var_values, order = FALSE) {
  prah_schuzky = 7
  prah_celodenky = 6
  prah_vicedenky = 5
  prah_tabory = 4
    
     #V response je array 8 pravdepodobnosti pro schuzky, 8 pro celoden, 7 pro viceden (protoze 8 se v datech nevyskytuje) a 5 pro tabor (zase se nevyskytuji vyssi)
  offset_schuzky = 1
  offset_celodenky = offset_schuzky + max(aktivita_pro_model$frekvence_rs_akci_schuzky) 
  offset_vicedenky = offset_celodenky + max(aktivita_pro_model$frekvence_rs_akci_celodenni_akce)
  offset_tabory = offset_vicedenky + max(aktivita_pro_model$frekvence_rs_akci_vicedenni_akce)
  
  
  data_with_response <- aktivita_pro_model %>% 
    mutate(response_positive = 
                frekvence_rs_akci_schuzky >= prah_schuzky |
                frekvence_rs_akci_celodenni_akce >= prah_celodenky |
                frekvence_rs_akci_vicedenni_akce >= prah_vicedenky |
                frekvence_rs_akci_tabory_expedice >= prah_tabory )
  
  if(order) {
    order_perm <- order_by_response_positive(data_with_response, var_name, var_values)
    var_values = var_values[order_perm]
    var_labels = var_labels[order_perm]
  }
  
  
  effects_by_prediction(fit_aktivita, 
                        data_with_response, 
                        var_name, 
                        var_values, 
                        var_labels = var_labels,
                        response_to_value_func = function(x) {
                         
                          1 - 
                            sum(x[offset_schuzky:(offset_schuzky + prah_schuzky - 2)]) * 
                            sum(x[offset_celodenky:(offset_celodenky + prah_celodenky - 2)]) * 
                            sum(x[offset_vicedenky:(offset_vicedenky + prah_vicedenky - 2)]) * 
                            sum(x[offset_tabory:(offset_tabory + prah_tabory - 2)])
                          }, 
                        response_title = "P(spíše aktivní než ne)")
}
```



```{r}
veky <- seq(15,25, by = 2)
effects_by_prediction_spokojenost("vek", normalized_translator_vek(veky), var_labels = continous_var_labels(veky))

effects_by_prediction_spokojenost("pohlavi", c("Neuvedeno","Žena","Muž"))

effects_by_prediction_spokojenost("velikost_obce")

effects_by_prediction_spokojenost("kraj", order = TRUE)

```

```{r}
pocty_lidi <- seq(5,30, by = 5)
effects_by_prediction_spokojenost("kmen_kolik_aktivnich_lidi", normalized_translator_aktivni_lide(pocty_lidi), var_labels = continous_var_labels(pocty_lidi))

roky_kmene <- c(1,2,4,8,16)
effects_by_prediction_spokojenost("kolik_let_rs_kmen_funguje", normalized_translator_let_funguje(roky_kmene), var_labels = continous_var_labels(roky_kmene ))


effects_by_prediction_spokojenost("rs_kmen_prvky_vudce", c("Ne", "Ano"))

effects_by_prediction_spokojenost("rs_kmen_prvky_rada", c("Ne", "Ano"))
effects_by_prediction_spokojenost("kdo_pripravuje_program", c("Nevím", "Neuvedeno","vudce","uzka_skupina", "vsichni"))

effects_by_prediction_spokojenost("povazujes_se_za_rovera", c("Neuvedeno","Ne_ale_budu","Ne_ale_byl", "Ano"))

effects_by_prediction_spokojenost("studium_ve_meste_strediska", c("Ne", "Ano"))

effects_by_prediction_spokojenost("max_funkce")

effects_by_prediction_spokojenost("je_ve_meste_univerzita", c("Ne","Ano"))
```

```{r}
effects_by_prediction_spokojenost("je_vice_rs_kmenu_ve_stredisku")
effects_by_prediction_spokojenost("je_rs_kmen_registrovany")

```








```{r}
effects_by_prediction_aktivita("vek", normalized_translator_vek(veky), var_labels = continous_var_labels(veky))

effects_by_prediction_aktivita("pohlavi", c("Neuvedeno","Žena","Muž"))

effects_by_prediction_aktivita("velikost_obce")

effects_by_prediction_aktivita("kraj", order = TRUE)
```


```{r}


effects_by_prediction_aktivita("kmen_kolik_aktivnich_lidi", normalized_translator_aktivni_lide(pocty_lidi), var_labels = continous_var_labels(pocty_lidi))

effects_by_prediction_aktivita("kolik_let_rs_kmen_funguje", normalized_translator_let_funguje(roky_kmene), var_labels = continous_var_labels(roky_kmene ))


effects_by_prediction_aktivita("rs_kmen_prvky_vudce", c("Ne", "Ano"))

effects_by_prediction_aktivita("rs_kmen_prvky_rada", c("Ne", "Ano"))
effects_by_prediction_aktivita("kdo_pripravuje_program", c("Nevím", "Neuvedeno","uzka_skupina", "vsichni","vudce"))

effects_by_prediction_aktivita("povazujes_se_za_rovera", c("Neuvedeno","Ne_ale_budu","Ne_ale_byl", "Ano"))

effects_by_prediction_aktivita("studium_ve_meste_strediska", c("Ne", "Ano"))

effects_by_prediction_aktivita("max_funkce")

effects_by_prediction_aktivita("je_vice_rs_kmenu_ve_stredisku")
effects_by_prediction_aktivita("je_rs_kmen_registrovany")


```

```{r}
effects_by_prediction_aktivita("kraj")

```


# Hlavní kvantitativní výsledky

# Podrobnější a doplňkové výsledky

V datech ze sond je víc žen. Zároveň ženy proporčně častěji mají funkce (s vyjímkou vůdce střediska, vůdce kmene a oddílový rádce).

```{r}
pocet_pohlavi <- sondy %>% group_by(pohlavi) %>% summarise(pocet_pohlavi = length(id))

pocet_pohlavi

funkce_pohlavi <- sondy %>% filter(pohlavi != "N/A") %>% 
  group_by(pohlavi, max_funkce) %>% 
  summarise(pocet_funkce = length(id)) %>% 
  inner_join(pocet_pohlavi, by = c("pohlavi" = "pohlavi" )) %>%
  mutate(podil_funkce = pocet_funkce / pocet_pohlavi)

funkce_pohlavi %>%
  ggplot(aes(x = pohlavi, y = podil_funkce, color = max_funkce, group = max_funkce, shape = max_funkce)) + geom_point() + geom_line()

funkce_pohlavi %>%
  ggplot(aes(x = pohlavi, y = max_funkce, fill = podil_funkce)) + geom_bin2d(stat="identity")

```

Nedá se moc říct, že by spokojenost s programem RS kmene souvisela s funkcí ani s další sadou prediktorů.

```{r}
spokojenost <- sondy %>% 
  filter(!is.na(celkova_spokojenost_s_programem_rs_kmenu))

plot_spokojenost(spokojenost, "pohlavi")

plot_spokojenost(spokojenost, "max_funkce", plot="heatmap")
plot_spokojenost(spokojenost, "max_funkce")
plot_spokojenost(spokojenost, "max_funkce_v_kmeni")
plot_spokojenost(spokojenost, "je_ve_meste_univerzita")
plot_spokojenost(spokojenost, "studium_ve_meste_strediska")

plot_spokojenost(spokojenost, "je_vice_rs_kmenu_ve_stredisku")
#realne_vedeni_oddilu

plot_spokojenost(spokojenost, "je_rs_kmen_registrovany")

plot_spokojenost(spokojenost, "povazujes_se_za_rovera")
plot_spokojenost(spokojenost, "kdo_pripravuje_program")

```

Zdá se, že kmeny, které jsou vedeny jsou trochu spokojenější.

```{r}
plot_spokojenost(spokojenost %>% 
                   mutate(rs_kmen_prvky = if_else(rs_kmen_prvky_vudce == "Ano",
                                                  if_else(rs_kmen_prvky_rada == "Ano", "vudce_rada", "vudce"),
                                                  if_else(rs_kmen_prvky_rada == "Ano", "rada","nic")))
                 , "rs_kmen_prvky")

```


S rostoucím počet let v kmeni se spokojenost s programem kmenu snižuje. Kmeny, které mají více členů jsou spíše spokojenější. Naopak souvislost s počtem let, kolik funguje není moc viditelná.

```{r}
plot_spokojenost_continuous <- function(spokojenost, var) {
  spokojenost$var <- spokojenost[[var]]
  
  spokojenost <- spokojenost %>% filter(!is.na(var))
  
  spokojenost %>% ggplot(aes(x = celkova_spokojenost_s_programem_rs_kmenu, y = var)) + geom_boxplot(outlier.alpha = 0) +
    geom_jitter( alpha = 0.2) + ylab(var)
}

plot_spokojenost_continuous(spokojenost %>% filter(kolik_let_jsi_rover < 20), "kolik_let_jsi_rover") #Odfiltruju jeden outlier

plot_spokojenost_continuous(spokojenost, "kmen_kolik_aktivnich_lidi")
plot_spokojenost_continuous(spokojenost, "kolik_let_rs_kmen_funguje")

```

Lineární model pro spokojenost. Ignorujeme ty, co mají neuvedené číselné hodnoty. U výběru z možností zavádíme kategorii "Neuvedeno" (hulvátský, ale co už). 
V zásadě se dá říct, že model podporuje to, co jsme  viděli v grafech výše: kmeny s více lidmi jsou spokojenější (to je nejsilnější pozorovaná korelace), kmeny s vůdcem jsou více spokojené. Ostatní věci se pohybují někde kolem nuly.

TODO: rozmyslet 1||x vs x (první se lépe čte, ale pro binární není moc vhodné)



TODO: velikost tecky




```{r}
celkova_aktivita_dle_prahu <- function(prahy) {
  aktivita_pro_model %>% summarise(podil = 1 - mean(frekvence_rs_akci_schuzky < prahy[1] & frekvence_rs_akci_celodenni_akce < prahy[2] & frekvence_rs_akci_vicedenni_akce < prahy[3] & frekvence_rs_akci_tabory_expedice < prahy[4])) %>% pull(podil)
}

celkova_aktivita_dle_prahu(c(7,6,5,4))

```

