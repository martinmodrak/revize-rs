
# Co se pojí s

```{r setup}
source(here::here("setup_dotaznik.R"), encoding = "UTF-8")

source(here::here("datasety_dotaznik.R"), encoding = "UTF-8")

library(formula.tools)
library(INLA) #Install via install.packages("INLA", repos=c(getOption("repos"), INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE)

```



```{r}
all_marginals_file <- here::here("local_data", "all_marginals.rds")
if(!file.exists(all_marginals_file)) {
  stop("Nenalezeny spocitane fity. Spust `spocitej_INLA_kompetence.R` nebo pozadej Orla o nasdileni spocitanych vysledku.")
}
all_marginals <- readRDS(file = here::here("local_data", "all_marginals.rds"))
```



```{r}
base_for_inla <- get_base_for_inla(hlavni_data_long)


all_mc_sloupce <- names(mc_sloupce) 
all_marginals_processed <- all_marginals
for(mc_sl in all_mc_sloupce) {
  marginal_pattern <- paste0("^id\\.", mc_sl,"(_NA|\\.[a-z_1-9A-Z]*)?$")
  current_marginal <-  all_marginals_processed %>% filter(grepl(marginal_pattern, marginal))
  
  if(nrow(current_marginal) == 0) {
    next;
  }
  
  unique_res <- current_marginal %>% 
    group_by(kategorie, kompetence, zakladni, dalsi, meritko, index) %>%
    summarise(max_shift_q0.5 = max(q0.5 - mean(q0.5)) / max(1, mean(q0.5)), 
              max_shift_q0.025 = max(q0.025 - mean(q0.025)) / max(1, mean(q0.025)), 
              vals = paste0(unique(q0.5), collapse = ","),
              .groups = "drop") 
  
  bad_unique_res <- unique_res %>%
    filter(max_shift_q0.5 > 1e-2 | max_shift_q0.5 > 1e-2)
  
  if(nrow(bad_unique_res) > 0.1 * nrow(unique_res)) {
    print(bad_unique_res)
    print(paste0("Bad match ", mc_sl))
  }

  popisky_mc <- popisky_voleb_nazev(hlavni_data, mc_sl)
  
  current_marginal_processed <- current_marginal %>%
    mutate(index_int = as.integer(gsub("^index\\.", "", index)),
           marginal_old = marginal,
           marginal = case_when(marginal == paste0("id.", mc_sl) ~ paste0("id.", mc_sl, ".", popisky_mc[1]), 
                                marginal == paste0("id.", mc_sl, "_NA") ~ paste0("id.", mc_sl, ".NA"),
                                TRUE ~ marginal),
           expected_marginal = paste0("id.", mc_sl, ".", popisky_mc[index_int])
    ) %>%
    filter(marginal == expected_marginal)
    
  reduction_factor <- length(popisky_mc)
  if(any(is.na(base_for_inla[[mc_sl]])) ) {
    reduction_factor <- reduction_factor + 1
  }
  if(nrow(current_marginal_processed) *  reduction_factor !=  nrow(current_marginal)) {
    print(current_marginal %>% anti_join(current_marginal_processed, by = c("kategorie", "kompetence", "zakladni", "dalsi", "meritko", "marginal" = "marginal_old")))
    stop("Bad processing")
  }
  
  
  all_marginals_processed <- all_marginals_processed %>% 
    filter(!grepl(marginal_pattern, marginal)) %>%
    rbind(current_marginal_processed %>% select(-marginal_old, -expected_marginal, -index_int))
}

organizace_strucne_processed <- all_marginals_processed %>% 
  filter(marginal == "organizace_strucne") %>%
  mutate(index_int = as.integer(gsub("^index\\.", "", index)),
         index = levels(base_for_inla$organizace_strucne)[index_int]) %>%
  select(-index_int)
  

all_marginals_processed <- all_marginals_processed %>%
  filter(marginal != "organizace_strucne") %>%
  rbind(organizace_strucne_processed)


all_marginals_processed <- all_marginals_processed %>%
  mutate(matches_mc = grepl("^id\\.[^.]*\\.[^.]*$", marginal),
         index = if_else(matches_mc, gsub("^id\\.[^.]*\\.", "", marginal),  index),
         marginal = if_else(matches_mc, gsub("^id\\.","", gsub("\\.[^.]*$", "", marginal)),  marginal),
         marginal = gsub("Ano$", "", marginal),
         )
```



```{r}
marginals_to_show <- all_marginals_processed %>% 
  filter(!(marginal %in% c("age_ar", "kolik_casu", "(Intercept)", "sexjinak_neuvedeno")),
         !grepl("nevyplneno$", marginal),
         index != "NA") %>%
  #group_by(marginal) %>%
  #filter(any(abs(widest_ci_sign) > 0.9)) %>%
  #filter(marginal == "organizace_strucne") %>%
  #ungroup() %>%
  mutate(index_to_show = if_else(grepl("^index.[0-9]*", index), "", index),
         model = paste(meritko, zakladni, dalsi),
         model_label = paste(case_when(meritko == "kompetence_odpoved" ~ "Abs.",
                                       meritko == "kompetence_relativne_k_sobe" ~ "Rel.",
                                       TRUE ~ meritko),
                             if_else(zakladni == "zaklad", "", zakladni), 
                             case_when(dalsi == "minimal" ~ "A",
                                       dalsi == "zaklad" ~ "B",
                                       TRUE ~ dalsi))) %>%
  inner_join(kompetence_otazky %>% select(kompetence, popis_pro_grafy), by = "kompetence")

min_ci <- -1
max_ci <- 1
scale_fill_asociace <- scale_fill_gradientn("Asociace", limits = c(min_ci,max_ci),
                                 colours = c("#762a83","#f0f0f0", "#f0f0f0", "#1b7837"),
                                 values = c(0, 0.2,0.8,1),
                                 breaks = c(0.9, 0.7, -0.7, -0.9))

plot_single_marginal <- function(marginals_to_show, m, ind, title = m){
 data_to_plot <- marginals_to_show %>%
          filter(marginal == m, index == ind) 
 
 index_to_show <- data_to_plot$index_to_show %>% unique()
 if(length(index_to_show) > 1) {
   stop("Too many indices to show")
 }
 if(index_to_show == "") {
   index_to_show <- NULL
 }
 
 data_to_plot %>%
          ggplot(aes(x = model_label, y = popis_pro_grafy, fill = widest_ci_sign)) +
            geom_tile() + 
            scale_fill_asociace +
            scale_y_discrete("Kompetence") +
            scale_x_discrete("Varianty modelu") +
            expand_limits(fill = c(min_ci,max_ci)) +
            #theme(axis.text.x = element_blank()) + 
            facet_wrap(~kategorie, nrow = 1) +
            plot_annotation(title, index_to_show)  
}



```

```{r}
plot_single_marginal(marginals_to_show, "sexmuz", "", title = "Je muž")
plot_single_marginal(marginals_to_show, "byl_na_kurzu", "")
plot_single_marginal(marginals_to_show, "byl_na_rs_kurzu","")
```


```{r}
other_marginals <- setdiff(unique(marginals_to_show$marginal), c("sexmuz", "byl_na_kurzu", "byl_na_rs_kurzu") )
  for(m in other_marginals) {
    index_vals <- marginals_to_show %>% filter(marginal == m) %>% pull(index) %>% unique()
    for(ind in index_vals) {
      print(plot_single_marginal(marginals_to_show, m, ind))
    }
  }
```


```{r}

#for(kategorie_to_show in unique(all_marginals_processed$kategorie)) {
  for(kompetence_to_show in unique(marginals_to_show$kompetence)) {
    print(
      marginals_to_show %>%
        filter(kompetence == kompetence_to_show) %>%
        group_by(marginal, index) %>%
        filter(any(abs(widest_ci_sign) > 0.7)) %>%
        ungroup() %>%
        mutate(prediktor = paste(marginal, index), model_label = fct_reorder(model_label, dalsi == "zaklad")) %>%
        ggplot(aes(x = model_label, y = prediktor, fill = widest_ci_sign)) +
          geom_tile() + 
          scale_fill_asociace +
          scale_x_discrete("Varianta modelu") +
          expand_limits(fill = c(min_ci,max_ci)) +
          facet_wrap(~kategorie, nrow = 1, scales = "free_x") +
          plot_annotation(kompetence_otazky %>% filter(kompetence == kompetence_to_show) %>% pull(popis_pro_grafy))
    )
 }

```


